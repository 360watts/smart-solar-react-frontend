"use strict";(self.webpackChunksmart_solar_frontend=self.webpackChunksmart_solar_frontend||[]).push([[923],{7923(e,t,r){r.d(t,{OTA:()=>o});var s=r(2555),a=r(5043),i=r(5560),n=(r(4050),r(579));const o=()=>{const[e,t]=(0,a.useState)([]),[r,o]=(0,a.useState)(null),[c,l]=(0,a.useState)(null),[d,h]=(0,a.useState)(!1),[u,m]=(0,a.useState)(null),[p,g]=(0,a.useState)({version:"",description:"",release_notes:""}),[y,v]=(0,a.useState)(null),[x,f]=(0,a.useState)(""),[b,j]=(0,a.useState)(""),[w,S]=(0,a.useState)({deviceSerial:"",notes:""}),[k,T]=(0,a.useState)("upload");(0,a.useEffect)(()=>{N()},[]);const N=async()=>{h(!0);try{const[e,r,s]=await Promise.all([i.K.getFirmwareVersions(!1),i.K.getOTAConfig(),i.K.getOTAHealth()]);t(e),o(r),v(r),l(s)}catch(e){j(e.message||"Failed to load OTA data")}finally{h(!1)}};return(0,n.jsxs)("div",{className:"admin-container",children:[(0,n.jsxs)("div",{className:"admin-header",style:{marginBottom:"2rem"},children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)("h1",{style:{display:"flex",alignItems:"center",gap:"0.75rem",marginBottom:"0.5rem"},children:[(0,n.jsxs)("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("path",{d:"M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"}),(0,n.jsx)("polyline",{points:"3.27 6.96 12 12.01 20.73 6.96"}),(0,n.jsx)("line",{x1:"12",y1:"22.08",x2:"12",y2:"12"})]}),"Over-The-Air (OTA) Updates"]}),(0,n.jsx)("p",{style:{color:"var(--text-secondary)",margin:0},children:"Manage firmware versions and deploy updates to your devices"})]}),(0,n.jsx)("div",{className:"health-status",children:c&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("span",{className:"status-badge status-badge-".concat("ok"===c.status?"success":"danger"),children:c.status.toUpperCase()}),(0,n.jsxs)("span",{className:"ml-2",children:[c.firmware_versions," versions (",c.active_firmware," active)"]})]})})]}),x&&(0,n.jsxs)("div",{className:"alert alert-success mt-3 fade-in",children:[x,(0,n.jsx)("button",{className:"alert-close",onClick:()=>f(""),children:"\xd7"})]}),b&&(0,n.jsxs)("div",{className:"alert alert-danger mt-3 fade-in",children:[b,(0,n.jsx)("button",{className:"alert-close",onClick:()=>j(""),children:"\xd7"})]}),d&&(0,n.jsx)("div",{className:"loading-spinner",children:"Loading OTA data..."}),(0,n.jsxs)("div",{style:{display:"flex",gap:"0.5rem",marginBottom:"1.5rem",borderBottom:"2px solid var(--border-color)",paddingBottom:"0"},children:[(0,n.jsxs)("button",{onClick:()=>T("upload"),style:{background:"upload"===k?"var(--primary-gradient)":"transparent",color:"upload"===k?"var(--text-primary)":"var(--text-secondary)",border:"none",padding:"0.75rem 1.5rem",cursor:"pointer",fontSize:"0.95rem",fontWeight:"upload"===k?"600":"500",borderRadius:"8px 8px 0 0",transition:"all 0.2s",display:"flex",alignItems:"center",gap:"0.5rem"},children:[(0,n.jsxs)("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),(0,n.jsx)("polyline",{points:"17 8 12 3 7 8"}),(0,n.jsx)("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]}),"Upload & Rollback"]}),(0,n.jsxs)("button",{onClick:()=>T("versions"),style:{background:"versions"===k?"var(--primary-gradient)":"transparent",color:"versions"===k?"var(--text-primary)":"var(--text-secondary)",border:"none",padding:"0.75rem 1.5rem",cursor:"pointer",fontSize:"0.95rem",fontWeight:"versions"===k?"600":"500",borderRadius:"8px 8px 0 0",transition:"all 0.2s",display:"flex",alignItems:"center",gap:"0.5rem"},children:[(0,n.jsxs)("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"}),(0,n.jsx)("rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",ry:"1"})]}),"Firmware Versions (",e.length,")"]}),(0,n.jsxs)("button",{onClick:()=>T("config"),style:{background:"config"===k?"var(--primary-gradient)":"transparent",color:"config"===k?"var(--text-primary)":"var(--text-secondary)",border:"none",padding:"0.75rem 1.5rem",cursor:"pointer",fontSize:"0.95rem",fontWeight:"config"===k?"600":"500",borderRadius:"8px 8px 0 0",transition:"all 0.2s",display:"flex",alignItems:"center",gap:"0.5rem"},children:[(0,n.jsxs)("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("circle",{cx:"12",cy:"12",r:"3"}),(0,n.jsx)("path",{d:"M12 1v6m0 6v6m-7-7h6m6 0h6"})]}),"Configuration"]}),(0,n.jsxs)("button",{onClick:()=>T("docs"),style:{background:"docs"===k?"var(--primary-gradient)":"transparent",color:"docs"===k?"var(--text-primary)":"var(--text-secondary)",border:"none",padding:"0.75rem 1.5rem",cursor:"pointer",fontSize:"0.95rem",fontWeight:"docs"===k?"600":"500",borderRadius:"8px 8px 0 0",transition:"all 0.2s",display:"flex",alignItems:"center",gap:"0.5rem"},children:[(0,n.jsxs)("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),(0,n.jsx)("polyline",{points:"14 2 14 8 20 8"}),(0,n.jsx)("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),(0,n.jsx)("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),(0,n.jsx)("polyline",{points:"10 9 9 9 8 9"})]}),"Documentation"]})]}),"upload"===k&&(0,n.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(400px, 1fr))",gap:"1.5rem"},children:[(0,n.jsxs)("div",{className:"admin-card",style:{height:"fit-content"},children:[(0,n.jsxs)("h2",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1.5rem"},children:[(0,n.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),(0,n.jsx)("polyline",{points:"17 8 12 3 7 8"}),(0,n.jsx)("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]}),"Upload New Firmware"]}),(0,n.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),u&&p.version)try{h(!0),j(""),f("");const e=new FormData;e.append("file",u),e.append("version",p.version),e.append("description",p.description||""),e.append("release_notes",p.release_notes||""),e.append("is_active","false"),await i.K.uploadFirmwareVersion(e),f("Firmware uploaded successfully"),m(null),g({version:"",description:"",release_notes:""});const t=document.querySelector(".ota-file-input");t&&(t.value=""),N()}catch(t){console.error("Upload error:",t),j(t.message||"Failed to upload firmware")}finally{h(!1)}else j("Please select a file and enter version number")},className:"form",children:[(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Version (e.g., 0x00020000)"}),(0,n.jsx)("input",{type:"text",className:"form-control",placeholder:"0x00020000",value:p.version,onChange:e=>g((0,s.A)((0,s.A)({},p),{},{version:e.target.value}))})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Firmware File"}),(0,n.jsx)("input",{type:"file",className:"form-control ota-file-input",accept:".bin,.hex,.elf",onChange:e=>{var t;null!==(t=e.target.files)&&void 0!==t&&t[0]&&m(e.target.files[0])}}),u&&(0,n.jsxs)("small",{className:"form-text",children:["\ud83d\udce6 ",u.name]})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Description"}),(0,n.jsx)("textarea",{className:"form-control",placeholder:"Brief description of this firmware version",rows:2,value:p.description,onChange:e=>g((0,s.A)((0,s.A)({},p),{},{description:e.target.value}))})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Release Notes"}),(0,n.jsx)("textarea",{className:"form-control",placeholder:"Detailed release notes and changelog",rows:3,value:p.release_notes,onChange:e=>g((0,s.A)((0,s.A)({},p),{},{release_notes:e.target.value}))})]}),(0,n.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:d,style:{width:"100%"},children:d?"Uploading...":"\u2b06\ufe0f Upload Firmware"})]})]}),(0,n.jsxs)("div",{className:"admin-card",style:{height:"fit-content"},children:[(0,n.jsxs)("h2",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1.5rem"},children:[(0,n.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("polyline",{points:"1 4 1 10 7 10"}),(0,n.jsx)("path",{d:"M3.51 15a9 9 0 1 0 2.13-9.36L1 10"})]}),"Rollback Device Firmware"]}),(0,n.jsxs)("div",{style:{background:"rgba(255, 193, 7, 0.1)",border:"1px solid rgba(255, 193, 7, 0.3)",borderRadius:"8px",padding:"0.75rem 1rem",marginBottom:"1.5rem",display:"flex",gap:"0.75rem"},children:[(0,n.jsx)("span",{style:{fontSize:"1.25rem"},children:"\u26a0\ufe0f"}),(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:"Important:"})," Device must have previous firmware stored locally"]})]}),(0,n.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),!w.deviceSerial)return void j("Please enter a device serial for rollback");if(window.confirm("Are you sure you want to rollback device ".concat(w.deviceSerial,"?\n\n")+"This will trigger a firmware rollback command to the device.\nThe device must already have the previous firmware stored locally.\n\nThe device will receive updateFirmware flag = 2 in the heartbeat response."))try{h(!0),j(""),f(""),await i.K.triggerRollback(w.deviceSerial,w.notes),f("Rollback command sent to device ".concat(w.deviceSerial,". Device will receive the command on next heartbeat.")),S({deviceSerial:"",notes:""})}catch(t){console.error("Rollback error:",t),j(t.message||"Failed to trigger rollback")}finally{h(!1)}},className:"form",children:[(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Device Serial"}),(0,n.jsx)("input",{type:"text",className:"form-control",placeholder:"Enter device serial (e.g., STM32-001)",value:w.deviceSerial,onChange:e=>S((0,s.A)((0,s.A)({},w),{},{deviceSerial:e.target.value}))})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Notes (Optional)"}),(0,n.jsx)("textarea",{className:"form-control",placeholder:"Reason for rollback...",rows:2,value:w.notes,onChange:e=>S((0,s.A)((0,s.A)({},w),{},{notes:e.target.value}))})]}),(0,n.jsx)("button",{type:"submit",className:"btn btn-warning",disabled:d,style:{width:"100%"},children:d?"Processing...":"\u23ea Trigger Rollback"}),(0,n.jsxs)("small",{className:"form-text mt-2",style:{display:"block",textAlign:"center"},children:["Device will receive ",(0,n.jsx)("strong",{children:"updateFirmware: 2"})," flag on next heartbeat"]})]})]})]}),"versions"===k&&(0,n.jsxs)("div",{className:"admin-card",children:[(0,n.jsxs)("h2",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1.5rem"},children:[(0,n.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"}),(0,n.jsx)("rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",ry:"1"})]}),"Firmware Versions"]}),0===e.length?(0,n.jsxs)("div",{style:{textAlign:"center",padding:"3rem 1rem",color:"var(--text-secondary)"},children:[(0,n.jsxs)("svg",{width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",style:{margin:"0 auto 1rem",opacity:.3},children:[(0,n.jsx)("path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"}),(0,n.jsx)("rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",ry:"1"})]}),(0,n.jsx)("p",{style:{fontSize:"1.1rem",marginBottom:"0.5rem"},children:"No firmware versions uploaded yet"}),(0,n.jsx)("p",{style:{fontSize:"0.9rem"},children:"Upload your first firmware to get started"})]}):(0,n.jsx)("div",{className:"firmware-list",children:e.map(e=>(0,n.jsxs)("div",{className:"firmware-item ".concat(e.is_active?"active":""),style:{border:e.is_active?"2px solid var(--success-color)":"1px solid var(--border-color)",borderRadius:"12px",padding:"1.25rem",marginBottom:"1rem",background:e.is_active?"rgba(40, 167, 69, 0.05)":"var(--bg-secondary)",transition:"all 0.2s",position:"relative"},children:[e.is_active&&(0,n.jsx)("div",{style:{position:"absolute",top:"-10px",right:"20px",background:"var(--success-color)",color:"white",padding:"0.25rem 0.75rem",borderRadius:"12px",fontSize:"0.75rem",fontWeight:"600",boxShadow:"0 2px 8px rgba(40, 167, 69, 0.3)"},children:"\u2713 ACTIVE"}),(0,n.jsxs)("div",{className:"firmware-header",style:{display:"flex",alignItems:"center",gap:"0.75rem",marginBottom:"0.75rem",flexWrap:"wrap"},children:[(0,n.jsx)("span",{style:{background:e.is_active?"var(--primary-gradient)":"var(--bg-tertiary)",color:e.is_active?"var(--text-primary)":"var(--text-secondary)",padding:"0.5rem 1rem",borderRadius:"8px",fontWeight:"600",fontSize:"1rem",fontFamily:"monospace"},children:e.version}),(0,n.jsxs)("span",{style:{color:"var(--text-secondary)",fontSize:"0.9rem"},children:["\ud83d\udce6 ",e.filename]}),(0,n.jsxs)("span",{style:{marginLeft:"auto",background:"var(--bg-tertiary)",padding:"0.25rem 0.75rem",borderRadius:"6px",fontSize:"0.85rem",color:"var(--text-secondary)"},children:[(e.size/1024/1024).toFixed(2)," MB"]})]}),e.description&&(0,n.jsx)("p",{style:{color:"var(--text-secondary)",margin:"0.5rem 0",fontSize:"0.9rem"},children:e.description}),(0,n.jsxs)("div",{className:"firmware-footer",style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"1rem",paddingTop:"1rem",borderTop:"1px solid var(--border-color)"},children:[(0,n.jsxs)("small",{style:{color:"var(--text-secondary)"},children:["\ud83d\udcc5 ",new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})]}),(0,n.jsxs)("div",{className:"firmware-actions",style:{display:"flex",gap:"0.5rem"},children:[(0,n.jsx)("button",{className:"btn btn-sm ".concat(e.is_active?"btn-danger":"btn-success"),onClick:()=>(async e=>{try{h(!0),await i.K.updateFirmwareVersion(e.id,{is_active:!e.is_active}),f("Firmware ".concat(e.is_active?"deactivated":"activated"," successfully")),N()}catch(t){j(t.message||"Failed to update firmware status")}finally{h(!1)}})(e),disabled:d,style:{minWidth:"100px"},children:e.is_active?"\ud83d\udd34 Deactivate":"\u2713 Activate"}),(0,n.jsx)("button",{className:"btn btn-sm btn-danger",onClick:()=>(async e=>{if(e.is_active)return void j("Cannot delete active firmware. Deactivate it first.");if(window.confirm("Are you sure you want to delete firmware version ".concat(e.version,"?\n\n")+"This will permanently delete the firmware file from storage.\n\nThis action cannot be undone."))try{h(!0),j(""),f(""),await i.K.deleteFirmwareVersion(e.id),f("Firmware version ".concat(e.version," deleted successfully")),N()}catch(t){j(t.message||"Failed to delete firmware")}finally{h(!1)}})(e),disabled:d||e.is_active,title:e.is_active?"Deactivate firmware before deleting":"Delete firmware",children:"\ud83d\uddd1\ufe0f Delete"})]})]}),e.release_notes&&(0,n.jsxs)("details",{style:{marginTop:"1rem"},children:[(0,n.jsx)("summary",{style:{cursor:"pointer",fontWeight:"500",color:"var(--primary-color)",padding:"0.5rem",borderRadius:"6px",transition:"background 0.2s"},children:"\ud83d\udcdd Release Notes"}),(0,n.jsx)("p",{style:{marginTop:"0.75rem",padding:"1rem",background:"var(--bg-tertiary)",borderRadius:"8px",color:"var(--text-secondary)",fontSize:"0.9rem",whiteSpace:"pre-wrap"},children:e.release_notes})]})]},e.id))})]}),"config"===k&&(0,n.jsxs)("div",{className:"admin-card",children:[(0,n.jsxs)("h2",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1.5rem"},children:[(0,n.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("circle",{cx:"12",cy:"12",r:"3"}),(0,n.jsx)("path",{d:"M12 1v6m0 6v6m-7-7h6m6 0h6"})]}),"OTA Configuration"]}),y&&(0,n.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),y)try{h(!0),await i.K.updateOTAConfig(y),f("OTA configuration updated successfully"),o(y)}catch(t){j(t.message||"Failed to update configuration")}finally{h(!1)}},className:"form",style:{maxWidth:"800px"},children:[(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Update Strategy"}),(0,n.jsxs)("select",{className:"form-control",value:y.update_strategy,onChange:e=>v((0,s.A)((0,s.A)({},y),{},{update_strategy:e.target.value})),style:{padding:"0.75rem",borderRadius:"8px",border:"1px solid var(--border-color)",background:"var(--bg-secondary)"},children:[(0,n.jsx)("option",{value:"immediate",children:"\ud83d\ude80 Immediate - Push updates immediately"}),(0,n.jsx)("option",{value:"scheduled",children:"\ud83d\udcc5 Scheduled - Push during maintenance window"}),(0,n.jsx)("option",{value:"manual",children:"\ud83d\udc64 Manual - Wait for device to request"})]})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Max Concurrent Updates"}),(0,n.jsx)("input",{type:"number",className:"form-control",min:"1",max:"50",value:y.max_concurrent_updates,onChange:e=>v((0,s.A)((0,s.A)({},y),{},{max_concurrent_updates:parseInt(e.target.value)})),style:{padding:"0.75rem",borderRadius:"8px",border:"1px solid var(--border-color)",background:"var(--bg-secondary)"}}),(0,n.jsx)("small",{className:"form-text",style:{display:"block",marginTop:"0.5rem",color:"var(--text-secondary)"},children:"Maximum number of devices updating simultaneously"})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Firmware Retention (days)"}),(0,n.jsx)("input",{type:"number",className:"form-control",min:"1",max:"365",value:y.firmware_retention_days,onChange:e=>v((0,s.A)((0,s.A)({},y),{},{firmware_retention_days:parseInt(e.target.value)})),style:{padding:"0.75rem",borderRadius:"8px",border:"1px solid var(--border-color)",background:"var(--bg-secondary)"}}),(0,n.jsx)("small",{className:"form-text",style:{display:"block",marginTop:"0.5rem",color:"var(--text-secondary)"},children:"Keep old firmware files for this many days before cleanup"})]}),(0,n.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:d,style:{marginTop:"1rem"},children:d?"Saving...":"\ud83d\udcbe Save Configuration"})]})]}),"docs"===k&&(0,n.jsxs)("div",{className:"admin-card",children:[(0,n.jsxs)("h2",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1.5rem"},children:[(0,n.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),(0,n.jsx)("polyline",{points:"14 2 14 8 20 8"}),(0,n.jsx)("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),(0,n.jsx)("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),"API Documentation"]}),(0,n.jsxs)("div",{style:{display:"grid",gap:"1.5rem"},children:[(0,n.jsxs)("div",{style:{background:"var(--bg-secondary)",borderRadius:"12px",padding:"1.5rem",border:"1px solid var(--border-color)"},children:[(0,n.jsxs)("h3",{style:{marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:[(0,n.jsxs)("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,n.jsx)("circle",{cx:"12",cy:"12",r:"3"}),(0,n.jsx)("path",{d:"M12 1v6m0 6v6m-7-7h6m6 0h6"})]}),"OTA Update Strategy"]}),(0,n.jsx)("div",{style:{marginBottom:"1rem"},children:(0,n.jsxs)("strong",{style:{color:"var(--primary-color)"},children:["Current: ",null===r||void 0===r?void 0:r.update_strategy.toUpperCase()]})}),(0,n.jsxs)("ul",{style:{paddingLeft:"1.5rem",color:"var(--text-secondary)"},children:[(0,n.jsxs)("li",{style:{marginBottom:"0.5rem"},children:[(0,n.jsx)("strong",{children:"Immediate:"})," Updates offered to devices immediately when activated"]}),(0,n.jsxs)("li",{style:{marginBottom:"0.5rem"},children:[(0,n.jsx)("strong",{children:"Scheduled:"})," Updates offered during configured maintenance windows"]}),(0,n.jsxs)("li",{style:{marginBottom:"0.5rem"},children:[(0,n.jsx)("strong",{children:"Manual:"})," Devices must explicitly request updates via API"]})]})]}),(0,n.jsxs)("div",{style:{background:"var(--bg-secondary)",borderRadius:"12px",padding:"1.5rem",border:"1px solid var(--border-color)"},children:[(0,n.jsxs)("h3",{style:{marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:[(0,n.jsx)("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,n.jsx)("polyline",{points:"22 12 18 12 15 21 9 3 6 12 2 12"})}),"Heartbeat updateFirmware Flags"]}),(0,n.jsxs)("div",{style:{display:"grid",gap:"0.75rem",fontFamily:"monospace",fontSize:"0.9rem"},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"1rem",padding:"0.75rem",background:"var(--bg-tertiary)",borderRadius:"8px"},children:[(0,n.jsx)("span",{style:{background:"var(--bg-primary)",padding:"0.25rem 0.75rem",borderRadius:"6px",fontWeight:"600",minWidth:"40px",textAlign:"center"},children:"0"}),(0,n.jsx)("span",{style:{color:"var(--text-secondary)"},children:"No firmware update needed (default)"})]}),(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"1rem",padding:"0.75rem",background:"var(--bg-tertiary)",borderRadius:"8px"},children:[(0,n.jsx)("span",{style:{background:"var(--primary-color)",color:"white",padding:"0.25rem 0.75rem",borderRadius:"6px",fontWeight:"600",minWidth:"40px",textAlign:"center"},children:"1"}),(0,n.jsx)("span",{style:{color:"var(--text-secondary)"},children:"New firmware update available (device should update)"})]}),(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"1rem",padding:"0.75rem",background:"var(--bg-tertiary)",borderRadius:"8px"},children:[(0,n.jsx)("span",{style:{background:"var(--warning-color)",color:"white",padding:"0.25rem 0.75rem",borderRadius:"6px",fontWeight:"600",minWidth:"40px",textAlign:"center"},children:"2"}),(0,n.jsx)("span",{style:{color:"var(--text-secondary)"},children:"Rollback triggered (device should rollback to previous version)"})]})]})]}),(0,n.jsxs)("div",{style:{background:"var(--bg-secondary)",borderRadius:"12px",padding:"1.5rem",border:"1px solid var(--border-color)"},children:[(0,n.jsxs)("h3",{style:{marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:[(0,n.jsxs)("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,n.jsx)("polyline",{points:"16 18 22 12 16 6"}),(0,n.jsx)("polyline",{points:"8 6 2 12 8 18"})]}),"Device API Endpoints"]}),(0,n.jsxs)("div",{style:{display:"grid",gap:"1rem"},children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{style:{color:"var(--primary-color)"},children:"Check for Updates (STM32)"}),(0,n.jsx)("pre",{style:{background:"var(--bg-tertiary)",padding:"1rem",borderRadius:"8px",overflow:"auto",fontSize:"0.85rem",marginTop:"0.5rem",border:"1px solid var(--border-color)"},children:'POST /ota/devices/{device_id}/check\nContent-Type: application/json\n\n{\n  "device_id": "STM32-001",\n  "firmware_version": "0x00010000"\n}'})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{style:{color:"var(--primary-color)"},children:"Response Format"}),(0,n.jsx)("pre",{style:{background:"var(--bg-tertiary)",padding:"1rem",borderRadius:"8px",overflow:"auto",fontSize:"0.85rem",marginTop:"0.5rem",border:"1px solid var(--border-color)"},children:JSON.stringify({id:"fw_1",version:"0x00020000",size:1048576,url:"https://api.../ota/firmware/1/download",checksum:"sha256_hash",status:1},null,2)})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{style:{color:"var(--primary-color)"},children:"Heartbeat Endpoint"}),(0,n.jsx)("pre",{style:{background:"var(--bg-tertiary)",padding:"1rem",borderRadius:"8px",overflow:"auto",fontSize:"0.85rem",marginTop:"0.5rem",border:"1px solid var(--border-color)"},children:'POST /api/devices/{device_id}/heartbeat/\n\nResponse includes:\n{\n  "updateFirmware": 0,  // 0=none, 1=update, 2=rollback\n  "pendingReboot": false,\n  "hardReset": false\n}'})]})]})]})]})]})]})}},5560(e,t,r){r.d(t,{K:()=>c});var s=r(2555);class a{constructor(){this.cache=new Map,this.subscribers=new Map}set(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:a.DEFAULT_TTL,s=arguments.length>3?arguments[3]:void 0;this.cache.set(e,{data:t,timestamp:Date.now(),expiresIn:r,staleTime:null!==s&&void 0!==s?s:Math.min(r/2,a.STALE_TIME)}),this.notifySubscribers(e,t)}get(e){const t=this.cache.get(e);if(!t)return null;return Date.now()-t.timestamp>t.expiresIn?(this.cache.delete(e),null):t.data}getWithStaleStatus(e){var t;const r=this.cache.get(e);if(!r)return null;const s=Date.now()-r.timestamp,a=s>r.expiresIn,i=s>(null!==(t=r.staleTime)&&void 0!==t?t:r.expiresIn/2);return a?(this.cache.delete(e),null):{data:r.data,isStale:i,isExpired:!1}}has(e){const t=this.cache.get(e);if(!t)return!1;return!(Date.now()-t.timestamp>t.expiresIn)||(this.cache.delete(e),!1)}isStale(e){var t;const r=this.cache.get(e);if(!r)return!0;return Date.now()-r.timestamp>(null!==(t=r.staleTime)&&void 0!==t?t:r.expiresIn/2)}clear(e){this.cache.delete(e)}clearPattern(e){const t="string"===typeof e?new RegExp(e):e,r=[];this.cache.forEach((e,s)=>{t.test(s)&&r.push(s)}),r.forEach(e=>this.cache.delete(e))}clearAll(){this.cache.clear()}size(){return this.cache.size}subscribe(e,t){this.subscribers.has(e)||this.subscribers.set(e,new Set);const r={callback:t};return this.subscribers.get(e).add(r),()=>{const t=this.subscribers.get(e);t&&(t.delete(r),0===t.size&&this.subscribers.delete(e))}}subscribePattern(e,t){const r="__pattern__".concat(e.source);this.subscribers.has(r)||this.subscribers.set(r,new Set);const s={callback:t,pattern:e};return this.subscribers.get(r).add(s),()=>{const e=this.subscribers.get(r);e&&(e.delete(s),0===e.size&&this.subscribers.delete(r))}}notifySubscribers(e,t){const r=this.subscribers.get(e);r&&r.forEach(r=>{try{r.callback(t)}catch(s){console.error("Cache subscriber error for key ".concat(e,":"),s)}}),this.subscribers.forEach((r,s)=>{s.startsWith("__pattern__")&&r.forEach(r=>{if(r.pattern&&r.pattern.test(e))try{r.callback(t)}catch(s){console.error("Cache pattern subscriber error for key ".concat(e,":"),s)}})})}keys(){return Array.from(this.cache.keys())}getStats(){return{size:this.cache.size,keys:this.keys(),subscribers:Array.from(this.subscribers.values()).reduce((e,t)=>e+t.size,0)}}static getTTL(){switch(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"short"){case"realtime":return a.REALTIME_TTL;case"long":return a.LONG_TTL;default:return a.DEFAULT_TTL}}}a.DEFAULT_TTL=3e5,a.LONG_TTL=18e5,a.REALTIME_TTL=1e4,a.STALE_TIME=3e4;const i=new a,n=3e5,o="https://smart-solar-django-backend.vercel.app/api";const c=new class{getAuthHeaders(){const e=localStorage.getItem("authTokens");if(e)try{const t=JSON.parse(e);return{Authorization:"Bearer ".concat(t.access),"Content-Type":"application/json"}}catch(t){console.error("Error parsing auth tokens:",t)}return{"Content-Type":"application/json"}}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r="".concat(o).concat(e);let a=this.getAuthHeaders(),i=await fetch(r,(0,s.A)((0,s.A)({},t),{},{headers:(0,s.A)((0,s.A)({},a),t.headers)}));if(401===i.status){await this.refreshToken()&&(a=this.getAuthHeaders(),i=await fetch(r,(0,s.A)((0,s.A)({},t),{},{headers:(0,s.A)((0,s.A)({},a),t.headers)})))}if(401===i.status)throw localStorage.removeItem("authTokens"),localStorage.removeItem("authUser"),window.location.href="/login",new Error("Authentication required");if(!i.ok){const e=await i.text();throw new Error("API request failed: ".concat(i.status," ").concat(i.statusText," - ").concat(e))}return 204===i.status?null:i.json()}async refreshToken(){const e=localStorage.getItem("authTokens");if(!e)return!1;try{const t=JSON.parse(e),r=await fetch("".concat(o,"/auth/token/refresh/"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh:t.refresh})});if(r.ok){const e={access:(await r.json()).access,refresh:t.refresh};return localStorage.setItem("authTokens",JSON.stringify(e)),!0}}catch(t){console.error("Token refresh failed:",t)}return!1}async getConfiguration(){return this.request("/config/")}async getTelemetry(){return this.request("/telemetry/")}async provisionDevice(e){const t=await fetch("".concat(o,"/devices/provision"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error("Provisioning failed: ".concat(t.statusText));return t.json()}async getAlerts(){const e="alerts",t=i.get(e);if(t)return t;const r=await this.request("/alerts/");return i.set(e,r,n),r}async getSystemHealth(){const e="system_health",t=i.get(e);if(t)return t;const r=await this.request("/health/");return i.set(e,r,n),r}async getKPIs(){const e="kpis",t=i.get(e);if(t)return t;const r=await this.request("/kpis/");return i.set(e,r,n),r}async getUsers(e){const t="users_".concat(e||"all"),r=i.get(t);if(r)return r;const s=e?"?search=".concat(encodeURIComponent(e)):"",a=await this.request("/users/".concat(s));return i.set(t,a,n),a}async createUser(e){const t=await this.request("/users/create/",{method:"POST",body:JSON.stringify(e)});return i.clear("users_all"),i.clearAll(),t}async createEmployee(e){const t=await this.request("/users/create/",{method:"POST",body:JSON.stringify((0,s.A)((0,s.A)({},e),{},{is_staff:!0}))});return i.clear("users_all"),t}async getUserDevices(e){return this.request("/users/".concat(e,"/devices/"))}async getUserSite(e){return this.request("/users/".concat(e,"/site/"))}async createUserSite(e,t){return this.request("/users/".concat(e,"/site/"),{method:"POST",body:JSON.stringify(t)})}async updateUserSite(e,t){return this.request("/users/".concat(e,"/site/update/"),{method:"PUT",body:JSON.stringify(t)})}async getDeviceSite(e){return this.request("/devices/".concat(e,"/site/"))}async createDeviceSite(e,t){return this.request("/devices/".concat(e,"/site/"),{method:"POST",body:JSON.stringify(t)})}async updateDeviceSite(e,t){return this.request("/devices/".concat(e,"/site/update/"),{method:"PUT",body:JSON.stringify(t)})}async getSiteTelemetry(e,t){const r=new URLSearchParams;null!==t&&void 0!==t&&t.start_date&&r.append("start_date",t.start_date),null!==t&&void 0!==t&&t.end_date&&r.append("end_date",t.end_date),null!==t&&void 0!==t&&t.days&&r.append("days",t.days.toString());const s="/sites/".concat(e,"/telemetry/").concat(r.toString()?"?"+r.toString():"");return this.request(s)}async getSiteForecast(e,t){const r=new URLSearchParams;null!==t&&void 0!==t&&t.date&&r.append("date",t.date),null!==t&&void 0!==t&&t.start_date&&r.append("start_date",t.start_date),null!==t&&void 0!==t&&t.end_date&&r.append("end_date",t.end_date);const s="/sites/".concat(e,"/forecast/").concat(r.toString()?"?"+r.toString():"");return this.request(s)}async getSiteWeather(e){return this.request("/sites/".concat(e,"/weather/"))}async updateUser(e,t){const r=await this.request("/users/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)});return i.clear("users_all"),r}async deleteUser(e){const t=await this.request("/users/".concat(e,"/delete/"),{method:"DELETE"});return i.clear("users_all"),t}async getProfile(){return this.request("/profile/")}async updateProfile(e){return this.request("/profile/update/",{method:"PUT",body:JSON.stringify(e)})}async changePassword(e){return this.request("/profile/change-password/",{method:"POST",body:JSON.stringify(e)})}async getCustomers(e){const t=e?"?search=".concat(encodeURIComponent(e)):"";return this.request("/customers/".concat(t))}async createCustomer(e){return this.request("/customers/create/",{method:"POST",body:JSON.stringify(e)})}async getCustomer(e){return this.request("/customers/".concat(e,"/"))}async updateCustomer(e,t){return this.request("/customers/".concat(e,"/update/"),{method:"PUT",body:JSON.stringify(t)})}async deleteCustomer(e){return this.request("/customers/".concat(e,"/delete/"),{method:"DELETE"})}async getPresets(){const e="presets",t=i.get(e);if(t)return t;const r=await this.request("/presets/");return i.set(e,r,18e5),r}async createPreset(e){const t=await this.request("/presets/create/",{method:"POST",body:JSON.stringify(e)});return i.clear("presets"),t}async updatePreset(e,t){const r=await this.request("/presets/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)});return i.clear("presets"),r}async deletePreset(e){const t=await this.request("/presets/".concat(e,"/delete/"),{method:"DELETE"});return i.clear("presets"),t}async getGlobalSlaves(){return this.request("/slaves/")}async createGlobalSlave(e){return this.request("/slaves/create/",{method:"POST",body:JSON.stringify(e)})}async updateGlobalSlave(e,t){return this.request("/slaves/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)})}async deleteGlobalSlave(e){return this.request("/slaves/".concat(e,"/delete/"),{method:"DELETE"})}async getDevices(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:25;const s=new URLSearchParams;e&&s.append("search",e),s.append("page",t.toString()),s.append("page_size",r.toString());const a=s.toString();return this.request("/devices/?".concat(a))}async createDevice(e){return this.request("/devices/create/",{method:"POST",body:JSON.stringify(e)})}async updateDevice(e,t){return this.request("/devices/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)})}async deleteDevice(e){return this.request("/devices/".concat(e,"/delete/"),{method:"DELETE"})}async rebootDevice(e){return this.request("/devices/".concat(e,"/reboot/"),{method:"POST"})}async hardResetDevice(e){return this.request("/devices/".concat(e,"/hard-reset/"),{method:"POST"})}async getDeviceLogs(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this.request("/devices/".concat(e,"/logs/?limit=").concat(t,"&offset=").concat(r))}async toggleDeviceLogs(e,t){return this.request("/devices/".concat(e,"/logs/toggle/"),{method:"POST",body:JSON.stringify({enabled:t})})}async deleteDevicesBulk(e){return this.request("/devices/delete-bulk/",{method:"POST",body:JSON.stringify({device_ids:e})})}async getSlaves(e){return this.request("/presets/".concat(e,"/slaves/"))}async createSlave(e,t){return this.request("/presets/".concat(e,"/slaves/create/"),{method:"POST",body:JSON.stringify(t)})}async updateSlave(e,t,r){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/"),{method:"PUT",body:JSON.stringify(r)})}async deleteSlave(e,t){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/delete/"),{method:"DELETE"})}async addSlavesToPreset(e,t){return this.request("/presets/".concat(e,"/slaves/add/"),{method:"POST",body:JSON.stringify({slave_ids:t})})}async detachSlaveFromPreset(e,t){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/detach/"),{method:"POST"})}async getFirmwareVersions(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=new URLSearchParams;return t.append("active",e.toString()),this.request("/ota/firmware/?".concat(t.toString()))}async uploadFirmwareVersion(e){const t="".concat(o,"/ota/firmware/create/"),r=localStorage.getItem("authTokens");if(!r)throw new Error("Authentication required");const s=JSON.parse(r);let a={Authorization:"Bearer ".concat(s.access)},i=await fetch(t,{method:"POST",headers:a,body:e});if(401===i.status){if(await this.refreshToken()){const r=JSON.parse(localStorage.getItem("authTokens")||"{}");a={Authorization:"Bearer ".concat(r.access)},i=await fetch(t,{method:"POST",headers:a,body:e})}}if(401===i.status)throw localStorage.removeItem("authTokens"),localStorage.removeItem("authUser"),window.location.href="/login",new Error("Authentication required");if(!i.ok){const e=await i.text();throw new Error("Upload failed: ".concat(i.status," ").concat(i.statusText," - ").concat(e))}return i.json()}async updateFirmwareVersion(e,t){return this.request("/ota/firmware/".concat(e,"/"),{method:"PATCH",body:JSON.stringify(t)})}async deleteFirmwareVersion(e){return this.request("/ota/firmware/".concat(e,"/delete/"),{method:"DELETE"})}async getDeviceUpdateLogs(e){return this.request("/ota/devices/".concat(e,"/logs"))}async getOTAConfig(){return this.request("/ota/config/")}async updateOTAConfig(e){return this.request("/ota/config/update/",{method:"PATCH",body:JSON.stringify(e)})}async getOTAHealth(){return this.request("/ota/health/")}async triggerRollback(e,t){return this.request("/ota/updates/rollback/",{method:"POST",body:JSON.stringify({device_serial:e,notes:t||""})})}}}}]);
//# sourceMappingURL=923.0f91611b.chunk.js.map