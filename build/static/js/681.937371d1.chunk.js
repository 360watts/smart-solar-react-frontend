"use strict";(self.webpackChunksmart_solar_frontend=self.webpackChunksmart_solar_frontend||[]).push([[681],{4681(e,t,s){s.r(t),s.d(t,{default:()=>l});var r=s(2555),a=s(5043),n=s(5560),i=s(579);const l=()=>{const[e,t]=(0,a.useState)([]),[s,l]=(0,a.useState)([]),[c,o]=(0,a.useState)(!0),[d,u]=(0,a.useState)(null),[h,m]=(0,a.useState)(null),[x,g]=(0,a.useState)(!1),[p,y]=(0,a.useState)(""),[j,f]=(0,a.useState)(null),[v,b]=(0,a.useState)([]),[A,N]=(0,a.useState)(!1),[_,w]=(0,a.useState)({first_name:"",last_name:"",email:"",mobile_number:"",address:""}),[S,C]=(0,a.useState)({username:"",email:"",password:"",first_name:"",last_name:"",mobile_number:"",address:""});(0,a.useEffect)(()=>{E()},[]);const[T,q]=(0,a.useState)("");(0,a.useEffect)(()=>{const e=setTimeout(()=>{q(p)},300);return()=>clearTimeout(e)},[p]),(0,a.useEffect)(()=>{E(T)},[T]);const E=async e=>{try{const s=(await n.K.getUsers(e)).filter(e=>!e.is_staff);t(s),l(s),o(!1)}catch(s){u(s instanceof Error?s.message:"An error occurred"),o(!1)}},k=e=>{m(e),w({first_name:e.first_name,last_name:e.last_name,email:e.email,mobile_number:e.mobile_number||"",address:e.address||""})},U=async()=>{if(h)try{const s=await n.K.updateUser(h.id,_);t(e.map(e=>e.id===h.id?s:e)),m(null)}catch(s){u(s instanceof Error?s.message:"Failed to update user")}},D=()=>{f(null),b([])},O=()=>{m(null),g(!1)};return c?(0,i.jsx)("div",{className:"loading",children:"Loading users..."}):d?(0,i.jsxs)("div",{className:"error",children:["Error: ",d]}):j?(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",marginBottom:"20px"},children:[(0,i.jsx)("button",{onClick:D,className:"btn btn-secondary",style:{marginRight:"15px"},children:"\u2190 Back to Users"}),(0,i.jsxs)("h1",{style:{margin:0},children:[j.first_name," ",j.last_name,"'s Dashboard"]})]}),(0,i.jsxs)("div",{className:"card",style:{marginBottom:"20px"},children:[(0,i.jsxs)("div",{className:"card-header",children:[(0,i.jsx)("h2",{children:"User Information"}),(0,i.jsx)("button",{onClick:()=>k(j),className:"btn",children:"Edit User"})]}),(0,i.jsx)("div",{style:{padding:"20px"},children:(0,i.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"15px"},children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"Username:"}),(0,i.jsx)("p",{style:{margin:"5px 0"},children:j.username})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"Email:"}),(0,i.jsx)("p",{style:{margin:"5px 0"},children:j.email})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"Mobile:"}),(0,i.jsx)("p",{style:{margin:"5px 0"},children:j.mobile_number||"-"})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"Address:"}),(0,i.jsx)("p",{style:{margin:"5px 0"},children:j.address||"-"})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"Joined:"}),(0,i.jsx)("p",{style:{margin:"5px 0"},children:j.date_joined?new Date(j.date_joined).toLocaleDateString():"N/A"})]})]})})]}),(0,i.jsxs)("div",{className:"card",children:[(0,i.jsx)("div",{className:"card-header",children:(0,i.jsxs)("h2",{children:["Assigned Devices (",v.length,")"]})}),A?(0,i.jsx)("div",{style:{padding:"24px",textAlign:"center",color:"var(--text-secondary, #94a3b8)"},children:"Loading devices..."}):v.length>0?(0,i.jsxs)("table",{className:"table",children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{children:[(0,i.jsx)("th",{style:{textAlign:"center"},children:"Device Serial"}),(0,i.jsx)("th",{style:{textAlign:"center"},children:"Customer"}),(0,i.jsx)("th",{style:{textAlign:"center"},children:"Config Version"}),(0,i.jsx)("th",{style:{textAlign:"center"},children:"Provisioned At"})]})}),(0,i.jsx)("tbody",{children:v.map(e=>(0,i.jsxs)("tr",{children:[(0,i.jsx)("td",{style:{textAlign:"center"},children:e.device_serial}),(0,i.jsx)("td",{style:{textAlign:"center"},children:e.customer_name||"-"}),(0,i.jsx)("td",{style:{textAlign:"center"},children:e.config_version||"-"}),(0,i.jsx)("td",{style:{textAlign:"center"},children:e.provisioned_at?new Date(e.provisioned_at).toLocaleDateString():"-"})]},e.id))})]}):(0,i.jsx)("div",{style:{padding:"32px",textAlign:"center",color:"var(--text-muted, #64748b)",fontSize:"0.9375rem"},children:"No devices assigned to this user yet."})]}),h&&(0,i.jsx)("div",{className:"modal",children:(0,i.jsxs)("div",{className:"modal-content",children:[(0,i.jsxs)("h3",{children:["Edit User: ",h.username]}),(0,i.jsxs)("form",{onSubmit:e=>{e.preventDefault(),U()},children:[(0,i.jsxs)("div",{className:"form-group",style:{marginBottom:"15px"},children:[(0,i.jsx)("label",{children:"First Name:"}),(0,i.jsx)("input",{type:"text",value:_.first_name,onChange:e=>w((0,r.A)((0,r.A)({},_),{},{first_name:e.target.value})),required:!0,autoComplete:"off"})]}),(0,i.jsxs)("div",{className:"form-group",style:{marginBottom:"15px"},children:[(0,i.jsx)("label",{children:"Last Name:"}),(0,i.jsx)("input",{type:"text",value:_.last_name,onChange:e=>w((0,r.A)((0,r.A)({},_),{},{last_name:e.target.value})),required:!0,autoComplete:"off"})]}),(0,i.jsxs)("div",{className:"form-group",style:{marginBottom:"15px"},children:[(0,i.jsx)("label",{children:"Email:"}),(0,i.jsx)("input",{type:"email",value:_.email,onChange:e=>w((0,r.A)((0,r.A)({},_),{},{email:e.target.value})),required:!0,autoComplete:"off"})]}),(0,i.jsxs)("div",{className:"form-group",style:{marginBottom:"15px"},children:[(0,i.jsx)("label",{children:"Mobile Number:"}),(0,i.jsx)("input",{type:"tel",value:_.mobile_number,onChange:e=>w((0,r.A)((0,r.A)({},_),{},{mobile_number:e.target.value})),required:!0,autoComplete:"off"})]}),(0,i.jsxs)("div",{className:"form-group",style:{marginBottom:"15px"},children:[(0,i.jsx)("label",{children:"Address:"}),(0,i.jsx)("textarea",{value:_.address,onChange:e=>w((0,r.A)((0,r.A)({},_),{},{address:e.target.value})),autoComplete:"off"})]}),(0,i.jsxs)("div",{className:"form-actions",children:[(0,i.jsx)("button",{type:"submit",className:"btn",children:"Save"}),(0,i.jsx)("button",{type:"button",onClick:O,className:"btn btn-secondary",children:"Cancel"})]})]})]})})]}):(0,i.jsxs)("div",{children:[(0,i.jsx)("h1",{children:"User Management"}),(0,i.jsxs)("div",{className:"card",children:[(0,i.jsxs)("div",{className:"card-header",children:[(0,i.jsxs)("h2",{children:["Users (",s.length,")"]}),(0,i.jsxs)("div",{className:"card-actions",children:[(0,i.jsx)("input",{type:"text",placeholder:"Search users...",value:p,onChange:e=>{y(e.target.value)},className:"search-input"}),(0,i.jsx)("button",{onClick:()=>g(!0),className:"btn",children:"Register New User"})]})]}),(0,i.jsxs)("table",{className:"table",children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{children:[(0,i.jsx)("th",{style:{textAlign:"center"},children:"Name"}),(0,i.jsx)("th",{style:{textAlign:"center"},children:"Email"}),(0,i.jsx)("th",{style:{textAlign:"center"},children:"Mobile"}),(0,i.jsx)("th",{style:{textAlign:"center"},children:"Address"}),(0,i.jsx)("th",{style:{textAlign:"center"},children:"Joined"}),(0,i.jsx)("th",{style:{textAlign:"center"},children:"Actions"})]})}),(0,i.jsx)("tbody",{children:s.map(r=>(0,i.jsxs)("tr",{onClick:()=>(async e=>{f(e),N(!0);try{const t=await n.K.getUserDevices(e.id);b(t)}catch(t){b([])}finally{N(!1)}})(r),style:{cursor:"pointer"},className:"clickable-row",children:[(0,i.jsxs)("td",{children:[r.first_name," ",r.last_name]}),(0,i.jsx)("td",{children:r.email}),(0,i.jsx)("td",{children:r.mobile_number||"-"}),(0,i.jsx)("td",{children:r.address||"-"}),(0,i.jsx)("td",{children:(()=>{if(!r.date_joined)return"N/A";const e=new Date(r.date_joined);return isNaN(e.getTime())?"Invalid Date":e.toLocaleDateString()})()}),(0,i.jsxs)("td",{onClick:e=>e.stopPropagation(),children:[(0,i.jsx)("button",{onClick:()=>k(r),style:{background:"none",border:"none",cursor:"pointer",color:"var(--text-secondary, #94a3b8)"},title:"Edit",children:(0,i.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,i.jsx)("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),(0,i.jsx)("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]})}),(0,i.jsx)("button",{onClick:()=>(async r=>{if(window.confirm("Are you sure you want to delete user ".concat(r.username,"?")))try{await n.K.deleteUser(r.id),t(e.filter(e=>e.id!==r.id)),l(s.filter(e=>e.id!==r.id)),(null===j||void 0===j?void 0:j.id)===r.id&&(f(null),b([]))}catch(a){u(a instanceof Error?a.message:"Failed to delete user")}})(r),style:{background:"none",border:"none",cursor:"pointer",color:"var(--danger-color, #ef4444)"},title:"Delete",children:(0,i.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,i.jsx)("polyline",{points:"3,6 5,6 21,6"}),(0,i.jsx)("path",{d:"M19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"}),(0,i.jsx)("line",{x1:"10",y1:"11",x2:"10",y2:"17"}),(0,i.jsx)("line",{x1:"14",y1:"11",x2:"14",y2:"17"})]})})]})]},r.id))})]})]}),(h||x)&&(0,i.jsx)("div",{className:"modal",children:(0,i.jsxs)("div",{className:"modal-content",children:[(0,i.jsx)("h3",{children:h?"Edit User: ".concat(h.username):"Register New User"}),(0,i.jsxs)("form",{onSubmit:s=>{s.preventDefault(),h?U():(async()=>{try{const s=await n.K.createUser(S);t([...e,s]),g(!1),C({username:"",email:"",password:"",first_name:"",last_name:"",mobile_number:"",address:""})}catch(s){u(s instanceof Error?s.message:"Failed to create user")}})()},children:[(0,i.jsxs)("div",{className:"modal-body",children:[x&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("input",{type:"text",autoComplete:"username",style:{display:"none"}}),(0,i.jsx)("input",{type:"password",autoComplete:"current-password",style:{display:"none"}}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Username:"}),(0,i.jsx)("input",{type:"text",value:S.username,onChange:e=>C((0,r.A)((0,r.A)({},S),{},{username:e.target.value})),required:!0,autoComplete:"off"})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Password:"}),(0,i.jsx)("input",{type:"password",value:S.password,onChange:e=>C((0,r.A)((0,r.A)({},S),{},{password:e.target.value})),required:!0,autoComplete:"new-password"})]})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"First Name:"}),(0,i.jsx)("input",{type:"text",value:h?_.first_name:S.first_name,onChange:e=>h?w((0,r.A)((0,r.A)({},_),{},{first_name:e.target.value})):C((0,r.A)((0,r.A)({},S),{},{first_name:e.target.value})),required:!0,autoComplete:"off"})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Last Name:"}),(0,i.jsx)("input",{type:"text",value:h?_.last_name:S.last_name,onChange:e=>h?w((0,r.A)((0,r.A)({},_),{},{last_name:e.target.value})):C((0,r.A)((0,r.A)({},S),{},{last_name:e.target.value})),required:!0,autoComplete:"off"})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Email:"}),(0,i.jsx)("input",{type:"email",value:h?_.email:S.email,onChange:e=>h?w((0,r.A)((0,r.A)({},_),{},{email:e.target.value})):C((0,r.A)((0,r.A)({},S),{},{email:e.target.value})),required:!0,autoComplete:"off"})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Mobile Number:"}),(0,i.jsx)("input",{type:"tel",value:h?_.mobile_number:S.mobile_number,onChange:e=>h?w((0,r.A)((0,r.A)({},_),{},{mobile_number:e.target.value})):C((0,r.A)((0,r.A)({},S),{},{mobile_number:e.target.value})),required:!0,autoComplete:"off"})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Address:"}),(0,i.jsx)("textarea",{value:h?_.address:S.address,onChange:e=>h?w((0,r.A)((0,r.A)({},_),{},{address:e.target.value})):C((0,r.A)((0,r.A)({},S),{},{address:e.target.value})),autoComplete:"off"})]})]}),(0,i.jsxs)("div",{className:"form-actions",children:[(0,i.jsx)("button",{type:"submit",className:"btn",children:h?"Save":"Create"}),(0,i.jsx)("button",{type:"button",onClick:O,className:"btn btn-secondary",children:"Cancel"})]})]})]})})]})}},5560(e,t,s){s.d(t,{K:()=>c});var r=s(2555);class a{constructor(){this.cache=new Map}set(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:a.DEFAULT_TTL;this.cache.set(e,{data:t,timestamp:Date.now(),expiresIn:s})}get(e){const t=this.cache.get(e);if(!t)return null;return Date.now()-t.timestamp>t.expiresIn?(this.cache.delete(e),null):t.data}has(e){const t=this.cache.get(e);if(!t)return!1;return!(Date.now()-t.timestamp>t.expiresIn)||(this.cache.delete(e),!1)}clear(e){this.cache.delete(e)}clearAll(){this.cache.clear()}size(){return this.cache.size}static getTTL(){return"long"===(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"short")?a.LONG_TTL:a.DEFAULT_TTL}}a.DEFAULT_TTL=3e5,a.LONG_TTL=18e5;const n=new a,i=3e5,l="https://smart-solar-django-backend.vercel.app/api";const c=new class{getAuthHeaders(){const e=localStorage.getItem("authTokens");if(e)try{const t=JSON.parse(e);return{Authorization:"Bearer ".concat(t.access),"Content-Type":"application/json"}}catch(t){console.error("Error parsing auth tokens:",t)}return{"Content-Type":"application/json"}}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const s="".concat(l).concat(e);let a=this.getAuthHeaders(),n=await fetch(s,(0,r.A)((0,r.A)({},t),{},{headers:(0,r.A)((0,r.A)({},a),t.headers)}));if(401===n.status){await this.refreshToken()&&(a=this.getAuthHeaders(),n=await fetch(s,(0,r.A)((0,r.A)({},t),{},{headers:(0,r.A)((0,r.A)({},a),t.headers)})))}if(401===n.status)throw localStorage.removeItem("authTokens"),localStorage.removeItem("authUser"),window.location.href="/login",new Error("Authentication required");if(!n.ok){const e=await n.text();throw new Error("API request failed: ".concat(n.status," ").concat(n.statusText," - ").concat(e))}return n.json()}async refreshToken(){const e=localStorage.getItem("authTokens");if(!e)return!1;try{const t=JSON.parse(e),s=await fetch("".concat(l,"/auth/token/refresh/"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh:t.refresh})});if(s.ok){const e={access:(await s.json()).access,refresh:t.refresh};return localStorage.setItem("authTokens",JSON.stringify(e)),!0}}catch(t){console.error("Token refresh failed:",t)}return!1}async getConfiguration(){return this.request("/config/")}async getTelemetry(){return this.request("/telemetry/")}async provisionDevice(e){const t=await fetch("".concat(l,"/devices/provision"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error("Provisioning failed: ".concat(t.statusText));return t.json()}async getAlerts(){const e="alerts",t=n.get(e);if(t)return t;const s=await this.request("/alerts/");return n.set(e,s,i),s}async getSystemHealth(){const e="system_health",t=n.get(e);if(t)return t;const s=await this.request("/health/");return n.set(e,s,i),s}async getKPIs(){const e="kpis",t=n.get(e);if(t)return t;const s=await this.request("/kpis/");return n.set(e,s,i),s}async getUsers(e){const t="users_".concat(e||"all"),s=n.get(t);if(s)return s;const r=e?"?search=".concat(encodeURIComponent(e)):"",a=await this.request("/users/".concat(r));return n.set(t,a,i),a}async createUser(e){const t=await this.request("/users/create/",{method:"POST",body:JSON.stringify(e)});return n.clear("users_all"),n.clearAll(),t}async createEmployee(e){const t=await this.request("/users/create/",{method:"POST",body:JSON.stringify((0,r.A)((0,r.A)({},e),{},{is_staff:!0}))});return n.clear("users_all"),t}async getUserDevices(e){return this.request("/users/".concat(e,"/devices/"))}async updateUser(e,t){const s=await this.request("/users/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)});return n.clear("users_all"),s}async deleteUser(e){const t=await this.request("/users/".concat(e,"/delete/"),{method:"DELETE"});return n.clear("users_all"),t}async getProfile(){return this.request("/profile/")}async updateProfile(e){return this.request("/profile/update/",{method:"PUT",body:JSON.stringify(e)})}async changePassword(e){return this.request("/profile/change-password/",{method:"POST",body:JSON.stringify(e)})}async getCustomers(e){const t=e?"?search=".concat(encodeURIComponent(e)):"";return this.request("/customers/".concat(t))}async createCustomer(e){return this.request("/customers/create/",{method:"POST",body:JSON.stringify(e)})}async getCustomer(e){return this.request("/customers/".concat(e,"/"))}async updateCustomer(e,t){return this.request("/customers/".concat(e,"/update/"),{method:"PUT",body:JSON.stringify(t)})}async deleteCustomer(e){return this.request("/customers/".concat(e,"/delete/"),{method:"DELETE"})}async getPresets(){const e="presets",t=n.get(e);if(t)return t;const s=await this.request("/presets/");return n.set(e,s,18e5),s}async createPreset(e){const t=await this.request("/presets/create/",{method:"POST",body:JSON.stringify(e)});return n.clear("presets"),t}async updatePreset(e,t){const s=await this.request("/presets/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)});return n.clear("presets"),s}async deletePreset(e){const t=await this.request("/presets/".concat(e,"/delete/"),{method:"DELETE"});return n.clear("presets"),t}async getDevices(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:25;const r=new URLSearchParams;e&&r.append("search",e),r.append("page",t.toString()),r.append("page_size",s.toString());const a=r.toString();return this.request("/devices/?".concat(a))}async createDevice(e){return this.request("/devices/create/",{method:"POST",body:JSON.stringify(e)})}async updateDevice(e,t){return this.request("/devices/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)})}async deleteDevice(e){return this.request("/devices/".concat(e,"/delete/"),{method:"DELETE"})}async deleteDevicesBulk(e){return this.request("/devices/delete-bulk/",{method:"POST",body:JSON.stringify({device_ids:e})})}async getSlaves(e){return this.request("/presets/".concat(e,"/slaves/"))}async createSlave(e,t){return this.request("/presets/".concat(e,"/slaves/create/"),{method:"POST",body:JSON.stringify(t)})}async updateSlave(e,t,s){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/"),{method:"PUT",body:JSON.stringify(s)})}async deleteSlave(e,t){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/delete/"),{method:"DELETE"})}}}}]);
//# sourceMappingURL=681.937371d1.chunk.js.map