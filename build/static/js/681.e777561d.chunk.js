"use strict";(self.webpackChunksmart_solar_frontend=self.webpackChunksmart_solar_frontend||[]).push([[681],{4681(e,t,s){s.r(t),s.d(t,{default:()=>l});var r=s(9379),a=s(5043),n=s(3216),i=s(5560),o=s(8421),c=s(579);const l=()=>{const e=(0,n.Zp)(),{isDark:t}=(0,o.D)(),[s,l]=(0,a.useState)([]),[d,h]=(0,a.useState)([]),[u,m]=(0,a.useState)(!0),[g,p]=(0,a.useState)(null),[x,y]=(0,a.useState)(null),[f,b]=(0,a.useState)(!1),[v,j]=(0,a.useState)(""),[S,w]=(0,a.useState)(null),[A,N]=(0,a.useState)([]),[T,_]=(0,a.useState)(!1),[C,q]=(0,a.useState)({first_name:"",last_name:"",email:"",mobile_number:"",address:""}),[k,O]=(0,a.useState)({username:"",email:"",password:"",first_name:"",last_name:"",mobile_number:"",address:""}),[E,P]=(0,a.useState)({show:!1,user:null}),[D,U]=(0,a.useState)({show:!1,message:""});(0,a.useEffect)(()=>{J()},[]);const[I,L]=(0,a.useState)("");(0,a.useEffect)(()=>{const e=setTimeout(()=>{L(v)},300);return()=>clearTimeout(e)},[v]),(0,a.useEffect)(()=>{J(I)},[I]);const J=async e=>{try{const t=(await i.K.getUsers(e)).filter(e=>!e.is_staff);l(t),h(t),m(!1)}catch(t){p(t instanceof Error?t.message:"An error occurred"),m(!1)}},z=e=>{y(e),q({first_name:e.first_name,last_name:e.last_name,email:e.email,mobile_number:e.mobile_number||"",address:e.address||""})},M=async()=>{if(x)try{await i.K.updateUser(x.id,C),y(null),await J(v)}catch(e){p(e instanceof Error?e.message:"Failed to update user")}},R=()=>{w(null),N([])},F=()=>{y(null),b(!1)};return u?(0,c.jsx)("div",{className:"loading",children:"Loading users..."}):g?(0,c.jsxs)("div",{className:"error",children:["Error: ",g]}):S?(0,c.jsxs)("div",{children:[(0,c.jsxs)("div",{style:{display:"flex",alignItems:"center",marginBottom:"20px"},children:[(0,c.jsx)("button",{onClick:R,className:"btn btn-secondary",style:{marginRight:"15px"},children:"\u2190 Back to Users"}),(0,c.jsxs)("h1",{style:{margin:0},children:[S.first_name," ",S.last_name,"'s Dashboard"]})]}),(0,c.jsxs)("div",{className:"card",style:{marginBottom:"20px"},children:[(0,c.jsxs)("div",{className:"card-header",children:[(0,c.jsx)("h2",{children:"User Information"}),(0,c.jsx)("button",{onClick:()=>z(S),className:"btn",children:"Edit User"})]}),(0,c.jsx)("div",{style:{padding:"20px"},children:(0,c.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"15px"},children:[(0,c.jsxs)("div",{children:[(0,c.jsx)("strong",{children:"Username:"}),(0,c.jsx)("p",{style:{margin:"5px 0"},children:S.username})]}),(0,c.jsxs)("div",{children:[(0,c.jsx)("strong",{children:"Email:"}),(0,c.jsx)("p",{style:{margin:"5px 0"},children:S.email})]}),(0,c.jsxs)("div",{children:[(0,c.jsx)("strong",{children:"Mobile:"}),(0,c.jsx)("p",{style:{margin:"5px 0"},children:S.mobile_number||"-"})]}),(0,c.jsxs)("div",{children:[(0,c.jsx)("strong",{children:"Address:"}),(0,c.jsx)("p",{style:{margin:"5px 0"},children:S.address||"-"})]}),(0,c.jsxs)("div",{children:[(0,c.jsx)("strong",{children:"Joined:"}),(0,c.jsx)("p",{style:{margin:"5px 0"},children:S.date_joined?new Date(S.date_joined).toLocaleDateString():"N/A"})]})]})})]}),(0,c.jsxs)("div",{className:"card",style:{marginBottom:"20px"},children:[(0,c.jsx)("div",{className:"card-header",children:(0,c.jsxs)("h2",{children:["Assigned Devices (",A.length,")"]})}),T?(0,c.jsx)("div",{style:{padding:"24px",textAlign:"center",color:"var(--text-secondary, #94a3b8)"},children:"Loading devices..."}):A.length>0?(0,c.jsxs)("table",{className:"table",children:[(0,c.jsx)("thead",{children:(0,c.jsxs)("tr",{children:[(0,c.jsx)("th",{style:{textAlign:"center"},children:"Device Serial"}),(0,c.jsx)("th",{style:{textAlign:"center"},children:"MAC / HW ID"}),(0,c.jsx)("th",{style:{textAlign:"center"},children:"Model"}),(0,c.jsx)("th",{style:{textAlign:"center"},children:"Config Version"}),(0,c.jsx)("th",{style:{textAlign:"center"},children:"Provisioned At"})]})}),(0,c.jsx)("tbody",{children:A.map(t=>(0,c.jsxs)("tr",{className:"clickable-row",onClick:()=>e("/devices?deviceId=".concat(t.id)),style:{cursor:"pointer"},children:[(0,c.jsx)("td",{style:{textAlign:"center",fontFamily:"JetBrains Mono, monospace",fontSize:"0.85rem"},children:t.device_serial}),(0,c.jsx)("td",{style:{textAlign:"center",fontFamily:"JetBrains Mono, monospace",fontSize:"0.85rem"},children:t.hw_id||(0,c.jsx)("span",{style:{color:"var(--text-muted)"},children:"\u2014"})}),(0,c.jsx)("td",{style:{textAlign:"center"},children:t.model||(0,c.jsx)("span",{style:{color:"var(--text-muted)"},children:"\u2014"})}),(0,c.jsx)("td",{style:{textAlign:"center"},children:t.config_version||"-"}),(0,c.jsx)("td",{style:{textAlign:"center"},children:t.provisioned_at?new Date(t.provisioned_at).toLocaleDateString():"-"})]},t.id))})]}):(0,c.jsx)("div",{style:{padding:"32px",textAlign:"center",color:"var(--text-muted, #64748b)",fontSize:"0.9375rem"},children:"No devices assigned to this user yet."})]}),x&&(0,c.jsx)("div",{className:"modal",children:(0,c.jsxs)("div",{className:"modal-content",children:[(0,c.jsxs)("h3",{children:["Edit User: ",x.username]}),(0,c.jsxs)("form",{onSubmit:e=>{e.preventDefault(),M()},children:[(0,c.jsxs)("div",{className:"modal-body",children:[(0,c.jsxs)("div",{className:"form-section",children:[(0,c.jsx)("h4",{className:"form-section-title",children:"Account Information"}),(0,c.jsx)("div",{className:"form-grid",children:(0,c.jsxs)("div",{className:"form-group",children:[(0,c.jsx)("label",{children:"Email Address"}),(0,c.jsx)("input",{type:"email",value:C.email,onChange:e=>q((0,r.A)((0,r.A)({},C),{},{email:e.target.value})),required:!0,autoComplete:"off",placeholder:"john.doe@example.com"})]})})]}),(0,c.jsxs)("div",{className:"form-section",children:[(0,c.jsx)("h4",{className:"form-section-title",children:"Personal Details"}),(0,c.jsxs)("div",{className:"form-grid form-grid-2",children:[(0,c.jsxs)("div",{className:"form-group",children:[(0,c.jsx)("label",{children:"First Name"}),(0,c.jsx)("input",{type:"text",value:C.first_name,onChange:e=>q((0,r.A)((0,r.A)({},C),{},{first_name:e.target.value})),required:!0,autoComplete:"off",placeholder:"John"})]}),(0,c.jsxs)("div",{className:"form-group",children:[(0,c.jsx)("label",{children:"Last Name"}),(0,c.jsx)("input",{type:"text",value:C.last_name,onChange:e=>q((0,r.A)((0,r.A)({},C),{},{last_name:e.target.value})),required:!0,autoComplete:"off",placeholder:"Doe"})]})]})]}),(0,c.jsxs)("div",{className:"form-section",children:[(0,c.jsx)("h4",{className:"form-section-title",children:"Contact Information"}),(0,c.jsxs)("div",{className:"form-grid",children:[(0,c.jsxs)("div",{className:"form-group",children:[(0,c.jsx)("label",{children:"Mobile Number"}),(0,c.jsx)("input",{type:"tel",value:C.mobile_number,onChange:e=>q((0,r.A)((0,r.A)({},C),{},{mobile_number:e.target.value})),required:!0,autoComplete:"off",placeholder:"+1 (555) 000-0000"})]}),(0,c.jsxs)("div",{className:"form-group",children:[(0,c.jsx)("label",{children:"Address"}),(0,c.jsx)("textarea",{value:C.address,onChange:e=>q((0,r.A)((0,r.A)({},C),{},{address:e.target.value})),autoComplete:"off",rows:3,placeholder:"123 Solar Street..."})]})]})]})]}),(0,c.jsxs)("div",{className:"form-actions",style:{padding:"0 24px 24px 24px"},children:[(0,c.jsx)("button",{type:"submit",className:"btn",children:"Save Changes"}),(0,c.jsx)("button",{type:"button",onClick:F,className:"btn btn-secondary",children:"Cancel"})]})]})]})})]}):(0,c.jsxs)("div",{children:[(0,c.jsx)("h1",{children:"User Management"}),(0,c.jsxs)("div",{className:"card",children:[(0,c.jsxs)("div",{className:"card-header",children:[(0,c.jsxs)("h2",{children:["Users (",d.length,")"]}),(0,c.jsxs)("div",{className:"card-actions",children:[(0,c.jsx)("input",{type:"text",placeholder:"Search users...",value:v,onChange:e=>{j(e.target.value)},className:"search-input"}),(0,c.jsx)("button",{onClick:()=>b(!0),className:"btn",children:"Register New User"})]})]}),(0,c.jsxs)("table",{className:"table",children:[(0,c.jsx)("thead",{children:(0,c.jsxs)("tr",{children:[(0,c.jsx)("th",{style:{textAlign:"center"},children:"Name"}),(0,c.jsx)("th",{style:{textAlign:"center"},children:"Email"}),(0,c.jsx)("th",{style:{textAlign:"center"},children:"Mobile"}),(0,c.jsx)("th",{style:{textAlign:"center"},children:"Address"}),(0,c.jsx)("th",{style:{textAlign:"center"},children:"Joined"}),(0,c.jsx)("th",{style:{textAlign:"center"},children:"Actions"})]})}),(0,c.jsx)("tbody",{children:d.map(e=>(0,c.jsxs)("tr",{onClick:()=>(async e=>{w(e),_(!0);try{const t=await i.K.getUserDevices(e.id);N(t)}catch(t){console.error("Error fetching user devices:",t),N([])}finally{_(!1)}})(e),style:{cursor:"pointer"},className:"clickable-row",children:[(0,c.jsxs)("td",{style:{textAlign:"center"},children:[e.first_name," ",e.last_name]}),(0,c.jsx)("td",{style:{textAlign:"center"},children:e.email}),(0,c.jsx)("td",{style:{textAlign:"center"},children:e.mobile_number||"-"}),(0,c.jsx)("td",{style:{textAlign:"center"},children:e.address||"-"}),(0,c.jsx)("td",{style:{textAlign:"center"},children:(()=>{if(!e.date_joined)return"N/A";const t=new Date(e.date_joined);return isNaN(t.getTime())?"Invalid Date":t.toLocaleDateString()})()}),(0,c.jsxs)("td",{style:{textAlign:"center"},onClick:e=>e.stopPropagation(),children:[(0,c.jsx)("button",{onClick:()=>z(e),style:{background:"none",border:"none",cursor:"pointer",color:"var(--text-secondary, #94a3b8)",margin:"0 6px"},title:"Edit",children:(0,c.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,c.jsx)("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),(0,c.jsx)("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]})}),(0,c.jsx)("button",{onClick:()=>(e=>{console.log("\ud83d\uddd1\ufe0f handleDelete called with user:",e.username),P({show:!0,user:e})})(e),style:{background:"none",border:"none",cursor:"pointer",color:"var(--danger-color, #ef4444)",margin:"0 6px"},title:"Delete",children:(0,c.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,c.jsx)("polyline",{points:"3,6 5,6 21,6"}),(0,c.jsx)("path",{d:"M19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"}),(0,c.jsx)("line",{x1:"10",y1:"11",x2:"10",y2:"17"}),(0,c.jsx)("line",{x1:"14",y1:"11",x2:"14",y2:"17"})]})})]})]},e.id))})]})]}),(x||f)&&(0,c.jsx)("div",{className:"modal",children:(0,c.jsxs)("div",{className:"modal-content",children:[(0,c.jsx)("h3",{children:x?"Edit User: ".concat(x.username):"Register New User"}),(0,c.jsxs)("form",{onSubmit:e=>{e.preventDefault(),x?M():(async()=>{try{await i.K.createUser(k),b(!1),O({username:"",email:"",password:"",first_name:"",last_name:"",mobile_number:"",address:""}),await J(v)}catch(e){p(e instanceof Error?e.message:"Failed to create user")}})()},children:[(0,c.jsxs)("div",{className:"modal-body",children:[(0,c.jsxs)("div",{className:"form-section",children:[(0,c.jsx)("h4",{className:"form-section-title",children:"Account Information"}),(0,c.jsxs)("div",{className:"form-grid",children:[f&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("input",{type:"text",autoComplete:"username",style:{display:"none"}}),(0,c.jsx)("input",{type:"password",autoComplete:"current-password",style:{display:"none"}}),(0,c.jsxs)("div",{className:"form-group",children:[(0,c.jsx)("label",{children:"Username"}),(0,c.jsx)("input",{type:"text",value:k.username,onChange:e=>O((0,r.A)((0,r.A)({},k),{},{username:e.target.value})),required:!0,autoComplete:"off",placeholder:"jdoe"})]}),(0,c.jsxs)("div",{className:"form-group",children:[(0,c.jsx)("label",{children:"Password"}),(0,c.jsx)("input",{type:"password",value:k.password,onChange:e=>O((0,r.A)((0,r.A)({},k),{},{password:e.target.value})),required:!0,autoComplete:"new-password",placeholder:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022"})]})]}),(0,c.jsxs)("div",{className:"form-group",children:[(0,c.jsx)("label",{children:"Email Address"}),(0,c.jsx)("input",{type:"email",value:x?C.email:k.email,onChange:e=>x?q((0,r.A)((0,r.A)({},C),{},{email:e.target.value})):O((0,r.A)((0,r.A)({},k),{},{email:e.target.value})),required:!0,autoComplete:"off",placeholder:"john.doe@example.com"})]})]})]}),(0,c.jsxs)("div",{className:"form-section",children:[(0,c.jsx)("h4",{className:"form-section-title",children:"Personal Details"}),(0,c.jsxs)("div",{className:"form-grid form-grid-2",children:[(0,c.jsxs)("div",{className:"form-group",children:[(0,c.jsx)("label",{children:"First Name"}),(0,c.jsx)("input",{type:"text",value:x?C.first_name:k.first_name,onChange:e=>x?q((0,r.A)((0,r.A)({},C),{},{first_name:e.target.value})):O((0,r.A)((0,r.A)({},k),{},{first_name:e.target.value})),required:!0,autoComplete:"off",placeholder:"John"})]}),(0,c.jsxs)("div",{className:"form-group",children:[(0,c.jsx)("label",{children:"Last Name"}),(0,c.jsx)("input",{type:"text",value:x?C.last_name:k.last_name,onChange:e=>x?q((0,r.A)((0,r.A)({},C),{},{last_name:e.target.value})):O((0,r.A)((0,r.A)({},k),{},{last_name:e.target.value})),required:!0,autoComplete:"off",placeholder:"Doe"})]})]})]}),(0,c.jsxs)("div",{className:"form-section",children:[(0,c.jsx)("h4",{className:"form-section-title",children:"Contact Information"}),(0,c.jsxs)("div",{className:"form-grid",children:[(0,c.jsxs)("div",{className:"form-group",children:[(0,c.jsx)("label",{children:"Mobile Number"}),(0,c.jsx)("input",{type:"tel",value:x?C.mobile_number:k.mobile_number,onChange:e=>x?q((0,r.A)((0,r.A)({},C),{},{mobile_number:e.target.value})):O((0,r.A)((0,r.A)({},k),{},{mobile_number:e.target.value})),required:!0,autoComplete:"off",placeholder:"+1 (555) 000-0000"})]}),(0,c.jsxs)("div",{className:"form-group",children:[(0,c.jsx)("label",{children:"Address"}),(0,c.jsx)("textarea",{value:x?C.address:k.address,onChange:e=>x?q((0,r.A)((0,r.A)({},C),{},{address:e.target.value})):O((0,r.A)((0,r.A)({},k),{},{address:e.target.value})),autoComplete:"off",rows:3,placeholder:"123 Solar Street..."})]})]})]})]}),(0,c.jsxs)("div",{className:"form-actions",style:{padding:"0 24px 24px 24px"},children:[(0,c.jsx)("button",{type:"submit",className:"btn",children:x?"Save Changes":"Create Customer"}),(0,c.jsx)("button",{type:"button",onClick:F,className:"btn btn-secondary",children:"Cancel"})]})]})]})}),E.show&&E.user&&(0,c.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.6)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,backdropFilter:"blur(4px)"},children:(0,c.jsxs)("div",{style:{background:t?"#2d2d2d":"white",borderRadius:"16px",padding:"2rem",maxWidth:"500px",width:"90%",boxShadow:t?"0 20px 60px rgba(0,0,0,0.6)":"0 20px 60px rgba(0,0,0,0.3)",border:"2px solid #7f1d1d",animation:"slideIn 0.2s ease-out"},children:[(0,c.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"1rem",marginBottom:"1.5rem"},children:[(0,c.jsx)("div",{style:{width:"48px",height:"48px",borderRadius:"12px",background:"linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"1.5rem",animation:"pulse 2s infinite"},children:"\ud83d\uddd1\ufe0f"}),(0,c.jsx)("h3",{style:{fontSize:"1.5rem",fontWeight:"600",margin:0,color:"#7f1d1d"},children:"Delete User"})]}),(0,c.jsxs)("div",{style:{marginBottom:"1.5rem",color:t?"#b0b0b0":"#495057",lineHeight:"1.6"},children:[(0,c.jsxs)("p",{style:{marginBottom:"1rem"},children:["Are you sure you want to delete user ",(0,c.jsx)("strong",{style:{color:t?"#e0e0e0":"#2c3e50"},children:E.user.username}),"?"]}),(0,c.jsxs)("div",{style:{background:t?"rgba(127, 29, 29, 0.1)":"#fee2e2",border:t?"1px solid rgba(127, 29, 29, 0.3)":"1px solid #fecaca",borderRadius:"8px",padding:"0.75rem 1rem",fontSize:"0.9rem",color:t?"#fca5a5":"#991b1b"},children:[(0,c.jsx)("strong",{children:"\u26a0\ufe0f Warning:"})," This will permanently delete the user account. Any devices associated with this user will become unassigned."]})]}),(0,c.jsxs)("div",{style:{display:"flex",gap:"0.75rem",justifyContent:"flex-end"},children:[(0,c.jsx)("button",{onClick:()=>P({show:!1,user:null}),style:{background:t?"#3a3a3a":"#e0e0e0",color:t?"#e0e0e0":"#495057",border:"none",padding:"0.75rem 1.5rem",borderRadius:"8px",fontSize:"0.95rem",fontWeight:"600",cursor:"pointer",transition:"all 0.2s"},onMouseOver:e=>e.currentTarget.style.background=t?"#4a4a4a":"#d0d0d0",onMouseOut:e=>e.currentTarget.style.background=t?"#3a3a3a":"#e0e0e0",children:"Cancel"}),(0,c.jsx)("button",{onClick:async()=>{if(E.user)try{await i.K.deleteUser(E.user.id),l(s.filter(e=>e.id!==E.user.id)),h(d.filter(e=>e.id!==E.user.id)),(null===S||void 0===S?void 0:S.id)===E.user.id&&(w(null),N([])),P({show:!1,user:null}),U({show:!0,message:'User "'.concat(E.user.username,'" has been deleted successfully.')})}catch(e){p(e instanceof Error?e.message:"Failed to delete user"),P({show:!1,user:null})}},style:{background:"linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%)",color:"white",border:"none",padding:"0.75rem 1.5rem",borderRadius:"8px",fontSize:"0.95rem",fontWeight:"600",cursor:"pointer",boxShadow:"0 4px 12px rgba(127, 29, 29, 0.3)",transition:"all 0.2s"},onMouseOver:e=>e.currentTarget.style.transform="translateY(-1px)",onMouseOut:e=>e.currentTarget.style.transform="translateY(0)",children:"Yes, Delete"})]})]})}),D.show&&(0,c.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.4)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,backdropFilter:"blur(2px)"},children:(0,c.jsx)("div",{style:{background:t?"#2d2d2d":"white",borderRadius:"16px",padding:"2rem",maxWidth:"450px",width:"90%",boxShadow:t?"0 20px 60px rgba(0,0,0,0.6)":"0 20px 60px rgba(0,0,0,0.3)",border:t?"1px solid #28a745":"2px solid #28a745",animation:"slideIn 0.2s ease-out"},children:(0,c.jsxs)("div",{style:{textAlign:"center"},children:[(0,c.jsx)("div",{style:{width:"64px",height:"64px",borderRadius:"50%",background:"linear-gradient(135deg, #28a745 0%, #20c997 100%)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"2rem",margin:"0 auto 1rem",animation:"scaleIn 0.3s ease-out"},children:"\u2713"}),(0,c.jsx)("h3",{style:{fontSize:"1.5rem",fontWeight:"600",marginBottom:"1rem",color:t?"#e0e0e0":"#2c3e50"},children:"Success"}),(0,c.jsx)("p",{style:{color:t?"#b0b0b0":"#495057",lineHeight:"1.6",marginBottom:"1.5rem"},children:D.message}),(0,c.jsx)("button",{onClick:()=>U({show:!1,message:""}),style:{background:"linear-gradient(135deg, #28a745 0%, #20c997 100%)",color:"white",border:"none",padding:"0.75rem 2rem",borderRadius:"8px",fontSize:"0.95rem",fontWeight:"600",cursor:"pointer",boxShadow:"0 4px 12px rgba(40, 167, 69, 0.3)",transition:"all 0.2s"},onMouseOver:e=>e.currentTarget.style.transform="translateY(-1px)",onMouseOut:e=>e.currentTarget.style.transform="translateY(0)",children:"Got it!"})]})})})]})}},5560(e,t,s){s.d(t,{K:()=>c});var r=s(9379);class a{constructor(){this.cache=new Map,this.subscribers=new Map}set(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:a.DEFAULT_TTL,r=arguments.length>3?arguments[3]:void 0;this.cache.set(e,{data:t,timestamp:Date.now(),expiresIn:s,staleTime:null!==r&&void 0!==r?r:Math.min(s/2,a.STALE_TIME)}),this.notifySubscribers(e,t)}get(e){const t=this.cache.get(e);if(!t)return null;return Date.now()-t.timestamp>t.expiresIn?(this.cache.delete(e),null):t.data}getWithStaleStatus(e){var t;const s=this.cache.get(e);if(!s)return null;const r=Date.now()-s.timestamp,a=r>s.expiresIn,n=r>(null!==(t=s.staleTime)&&void 0!==t?t:s.expiresIn/2);return a?(this.cache.delete(e),null):{data:s.data,isStale:n,isExpired:!1}}has(e){const t=this.cache.get(e);if(!t)return!1;return!(Date.now()-t.timestamp>t.expiresIn)||(this.cache.delete(e),!1)}isStale(e){var t;const s=this.cache.get(e);if(!s)return!0;return Date.now()-s.timestamp>(null!==(t=s.staleTime)&&void 0!==t?t:s.expiresIn/2)}clear(e){this.cache.delete(e)}clearPattern(e){const t="string"===typeof e?new RegExp(e):e,s=[];this.cache.forEach((e,r)=>{t.test(r)&&s.push(r)}),s.forEach(e=>this.cache.delete(e))}clearAll(){this.cache.clear()}size(){return this.cache.size}subscribe(e,t){this.subscribers.has(e)||this.subscribers.set(e,new Set);const s={callback:t};return this.subscribers.get(e).add(s),()=>{const t=this.subscribers.get(e);t&&(t.delete(s),0===t.size&&this.subscribers.delete(e))}}subscribePattern(e,t){const s="__pattern__".concat(e.source);this.subscribers.has(s)||this.subscribers.set(s,new Set);const r={callback:t,pattern:e};return this.subscribers.get(s).add(r),()=>{const e=this.subscribers.get(s);e&&(e.delete(r),0===e.size&&this.subscribers.delete(s))}}notifySubscribers(e,t){const s=this.subscribers.get(e);s&&s.forEach(s=>{try{s.callback(t)}catch(r){console.error("Cache subscriber error for key ".concat(e,":"),r)}}),this.subscribers.forEach((s,r)=>{r.startsWith("__pattern__")&&s.forEach(s=>{if(s.pattern&&s.pattern.test(e))try{s.callback(t)}catch(r){console.error("Cache pattern subscriber error for key ".concat(e,":"),r)}})})}keys(){return Array.from(this.cache.keys())}getStats(){return{size:this.cache.size,keys:this.keys(),subscribers:Array.from(this.subscribers.values()).reduce((e,t)=>e+t.size,0)}}static getTTL(){switch(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"short"){case"realtime":return a.REALTIME_TTL;case"long":return a.LONG_TTL;default:return a.DEFAULT_TTL}}}a.DEFAULT_TTL=3e5,a.LONG_TTL=18e5,a.REALTIME_TTL=1e4,a.STALE_TIME=3e4;const n=new a,i=3e5,o="https://smart-solar-django-backend.vercel.app/api";const c=new class{getAuthHeaders(){const e=localStorage.getItem("authTokens");if(e)try{const t=JSON.parse(e);return{Authorization:"Bearer ".concat(t.access),"Content-Type":"application/json"}}catch(t){console.error("Error parsing auth tokens:",t)}return{"Content-Type":"application/json"}}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const s="".concat(o).concat(e);let a=this.getAuthHeaders(),n=await fetch(s,(0,r.A)((0,r.A)({},t),{},{headers:(0,r.A)((0,r.A)({},a),t.headers)}));if(401===n.status){await this.refreshToken()&&(a=this.getAuthHeaders(),n=await fetch(s,(0,r.A)((0,r.A)({},t),{},{headers:(0,r.A)((0,r.A)({},a),t.headers)})))}if(401===n.status)throw localStorage.removeItem("authTokens"),localStorage.removeItem("authUser"),window.location.href="/login",new Error("Authentication required");if(!n.ok){const e=await n.text();throw new Error("API request failed: ".concat(n.status," ").concat(n.statusText," - ").concat(e))}return 204===n.status?null:n.json()}async refreshToken(){const e=localStorage.getItem("authTokens");if(!e)return!1;try{const t=JSON.parse(e),s=await fetch("".concat(o,"/auth/token/refresh/"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh:t.refresh})});if(s.ok){const e={access:(await s.json()).access,refresh:t.refresh};return localStorage.setItem("authTokens",JSON.stringify(e)),!0}}catch(t){console.error("Token refresh failed:",t)}return!1}async getConfiguration(){return this.request("/config/")}async getTelemetry(){return this.request("/telemetry/")}async provisionDevice(e){const t=await fetch("".concat(o,"/devices/provision"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error("Provisioning failed: ".concat(t.statusText));return t.json()}async getAlerts(){const e="alerts",t=n.get(e);if(t)return t;const s=await this.request("/alerts/");return n.set(e,s,i),s}async getSystemHealth(){const e="system_health",t=n.get(e);if(t)return t;const s=await this.request("/health/");return n.set(e,s,i),s}async getKPIs(){const e="kpis",t=n.get(e);if(t)return t;const s=await this.request("/kpis/");return n.set(e,s,i),s}async getUsers(e){const t="users_".concat(e||"all"),s=n.get(t);if(s)return s;const r=e?"?search=".concat(encodeURIComponent(e)):"",a=await this.request("/users/".concat(r));return n.set(t,a,i),a}async createUser(e){const t=await this.request("/users/create/",{method:"POST",body:JSON.stringify(e)});return n.clear("users_all"),n.clearAll(),t}async createEmployee(e){const t=await this.request("/users/create/",{method:"POST",body:JSON.stringify((0,r.A)((0,r.A)({},e),{},{is_staff:!0}))});return n.clear("users_all"),t}async getUserDevices(e){return this.request("/users/".concat(e,"/devices/"))}async getUserSite(e){return this.request("/users/".concat(e,"/site/"))}async createUserSite(e,t){return this.request("/users/".concat(e,"/site/"),{method:"POST",body:JSON.stringify(t)})}async updateUserSite(e,t){return this.request("/users/".concat(e,"/site/update/"),{method:"PUT",body:JSON.stringify(t)})}async getDeviceSite(e){return this.request("/devices/".concat(e,"/site/"))}async createDeviceSite(e,t){return this.request("/devices/".concat(e,"/site/"),{method:"POST",body:JSON.stringify(t)})}async updateDeviceSite(e,t){return this.request("/devices/".concat(e,"/site/update/"),{method:"PUT",body:JSON.stringify(t)})}async getSiteTelemetry(e,t){const s=new URLSearchParams;null!==t&&void 0!==t&&t.start_date&&s.append("start_date",t.start_date),null!==t&&void 0!==t&&t.end_date&&s.append("end_date",t.end_date),null!==t&&void 0!==t&&t.days&&s.append("days",t.days.toString());const r="/sites/".concat(e,"/telemetry/").concat(s.toString()?"?"+s.toString():"");return this.request(r)}async getSiteHistory(e,t){const s=new URLSearchParams({start_date:t.start_date,end_date:t.end_date});return this.request("/sites/".concat(e,"/history/?").concat(s.toString()))}async getSiteForecast(e,t){const s=new URLSearchParams;null!==t&&void 0!==t&&t.date&&s.append("date",t.date),null!==t&&void 0!==t&&t.start_date&&s.append("start_date",t.start_date),null!==t&&void 0!==t&&t.end_date&&s.append("end_date",t.end_date);const r="/sites/".concat(e,"/forecast/").concat(s.toString()?"?"+s.toString():"");return this.request(r)}async getSiteWeather(e){return this.request("/sites/".concat(e,"/weather/"))}async updateUser(e,t){const s=await this.request("/users/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)});return n.clear("users_all"),s}async deleteUser(e){const t=await this.request("/users/".concat(e,"/delete/"),{method:"DELETE"});return n.clear("users_all"),t}async getProfile(){return this.request("/profile/")}async updateProfile(e){return this.request("/profile/update/",{method:"PUT",body:JSON.stringify(e)})}async changePassword(e){return this.request("/profile/change-password/",{method:"POST",body:JSON.stringify(e)})}async getCustomers(e){const t=e?"?search=".concat(encodeURIComponent(e)):"";return this.request("/customers/".concat(t))}async createCustomer(e){return this.request("/customers/create/",{method:"POST",body:JSON.stringify(e)})}async getCustomer(e){return this.request("/customers/".concat(e,"/"))}async updateCustomer(e,t){return this.request("/customers/".concat(e,"/update/"),{method:"PUT",body:JSON.stringify(t)})}async deleteCustomer(e){return this.request("/customers/".concat(e,"/delete/"),{method:"DELETE"})}async getPresets(){const e="presets",t=n.get(e);if(t)return t;const s=await this.request("/presets/");return n.set(e,s,18e5),s}async createPreset(e){const t=await this.request("/presets/create/",{method:"POST",body:JSON.stringify(e)});return n.clear("presets"),t}async updatePreset(e,t){const s=await this.request("/presets/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)});return n.clear("presets"),s}async deletePreset(e){const t=await this.request("/presets/".concat(e,"/delete/"),{method:"DELETE"});return n.clear("presets"),t}async getGlobalSlaves(){return this.request("/slaves/")}async createGlobalSlave(e){return this.request("/slaves/create/",{method:"POST",body:JSON.stringify(e)})}async updateGlobalSlave(e,t){return this.request("/slaves/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)})}async deleteGlobalSlave(e){return this.request("/slaves/".concat(e,"/delete/"),{method:"DELETE"})}async getDevices(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:25;const r=new URLSearchParams;e&&r.append("search",e),r.append("page",t.toString()),r.append("page_size",s.toString());const a=r.toString();return this.request("/devices/?".concat(a))}async createDevice(e){return this.request("/devices/create/",{method:"POST",body:JSON.stringify(e)})}async updateDevice(e,t){return this.request("/devices/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)})}async deleteDevice(e){return this.request("/devices/".concat(e,"/delete/"),{method:"DELETE"})}async rebootDevice(e){return this.request("/devices/".concat(e,"/reboot/"),{method:"POST"})}async hardResetDevice(e){return this.request("/devices/".concat(e,"/hard-reset/"),{method:"POST"})}async getDeviceLogs(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this.request("/devices/".concat(e,"/logs/?limit=").concat(t,"&offset=").concat(s))}async toggleDeviceLogs(e,t){return this.request("/devices/".concat(e,"/logs/toggle/"),{method:"POST",body:JSON.stringify({enabled:t})})}async deleteDevicesBulk(e){return this.request("/devices/delete-bulk/",{method:"POST",body:JSON.stringify({device_ids:e})})}async getSlaves(e){return this.request("/presets/".concat(e,"/slaves/"))}async createSlave(e,t){return this.request("/presets/".concat(e,"/slaves/create/"),{method:"POST",body:JSON.stringify(t)})}async updateSlave(e,t,s){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/"),{method:"PUT",body:JSON.stringify(s)})}async deleteSlave(e,t){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/delete/"),{method:"DELETE"})}async addSlavesToPreset(e,t){return this.request("/presets/".concat(e,"/slaves/add/"),{method:"POST",body:JSON.stringify({slave_ids:t})})}async detachSlaveFromPreset(e,t){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/detach/"),{method:"POST"})}async getFirmwareVersions(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=new URLSearchParams;return t.append("active",e.toString()),this.request("/ota/firmware/?".concat(t.toString()))}async uploadFirmwareVersion(e){const t="".concat(o,"/ota/firmware/create/"),s=localStorage.getItem("authTokens");if(!s)throw new Error("Authentication required");const r=JSON.parse(s);let a={Authorization:"Bearer ".concat(r.access)},n=await fetch(t,{method:"POST",headers:a,body:e});if(401===n.status){if(await this.refreshToken()){const s=JSON.parse(localStorage.getItem("authTokens")||"{}");a={Authorization:"Bearer ".concat(s.access)},n=await fetch(t,{method:"POST",headers:a,body:e})}}if(401===n.status)throw localStorage.removeItem("authTokens"),localStorage.removeItem("authUser"),window.location.href="/login",new Error("Authentication required");if(!n.ok){const e=await n.text();throw new Error("Upload failed: ".concat(n.status," ").concat(n.statusText," - ").concat(e))}return n.json()}async updateFirmwareVersion(e,t){return this.request("/ota/firmware/".concat(e,"/"),{method:"PATCH",body:JSON.stringify(t)})}async deleteFirmwareVersion(e){return this.request("/ota/firmware/".concat(e,"/delete/"),{method:"DELETE"})}async getDeviceUpdateLogs(e){return this.request("/ota/devices/".concat(e,"/logs"))}async getOTAConfig(){return this.request("/ota/config/")}async updateOTAConfig(e){return this.request("/ota/config/update/",{method:"PATCH",body:JSON.stringify(e)})}async getOTAHealth(){return this.request("/ota/health/")}async triggerRollback(e,t){return this.request("/ota/updates/rollback/",{method:"POST",body:JSON.stringify({device_serial:e,notes:t||""})})}async deployFirmware(e,t,s){return this.request("/ota/updates/multiple/",{method:"POST",body:JSON.stringify({firmware_id:e,device_serials:t,notes:s||""})})}async listTargetedUpdates(){return this.request("/ota/updates/")}async getTargetedUpdate(e){return this.request("/ota/updates/".concat(e,"/"))}}}}]);
//# sourceMappingURL=681.e777561d.chunk.js.map