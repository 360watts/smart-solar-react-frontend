"use strict";(self.webpackChunksmart_solar_frontend=self.webpackChunksmart_solar_frontend||[]).push([[340],{5340:(e,t,s)=>{s.r(t),s.d(t,{default:()=>i});var r=s(5043),a=s(3216),n=s(5560),c=s(579);const i=()=>{const{deviceId:e}=(0,a.g)(),t=(0,a.Zp)(),[s,i]=(0,r.useState)(null),[o,l]=(0,r.useState)([]),[d,h]=(0,r.useState)([]),[u,m]=(0,r.useState)(!0),[x,g]=(0,r.useState)(!1),[p,y]=(0,r.useState)(null),[f,v]=(0,r.useState)("overview");(0,r.useEffect)(()=>{e&&b()},[e]);const b=async()=>{try{m(!0);const t=await n.K.get("/devices/".concat(e,"/detail"));i(t.data.device),l(t.data.ota_statuses||[]),h(t.data.heartbeat_history||[]),y(null)}catch(r){var t,s;console.error("Error fetching device detail:",r),y((null===(t=r.response)||void 0===t||null===(s=t.data)||void 0===s?void 0:s.message)||"Failed to fetch device details")}finally{m(!1)}},j=async t=>{if(e)try{g(!0),await n.K.post("/devices/".concat(e,"/action"),{action:t}),alert("".concat(t.charAt(0).toUpperCase()+t.slice(1)," command sent successfully")),setTimeout(()=>{b()},1e3)}catch(a){var s,r;console.error("Error executing ".concat(t,":"),a),alert((null===(s=a.response)||void 0===s||null===(r=s.data)||void 0===r?void 0:r.message)||"Failed to execute ".concat(t))}finally{g(!1)}},N=e=>{switch(e.toLowerCase()){case"online":case"success":return"text-green-600 bg-green-100";case"offline":case"failed":return"text-red-600 bg-red-100";case"pending":return"text-yellow-600 bg-yellow-100";case"downloading":return"text-blue-600 bg-blue-100";case"installing":return"text-purple-600 bg-purple-100";default:return"text-gray-600 bg-gray-100"}};if(u)return(0,c.jsx)("div",{className:"flex justify-center items-center h-64",children:(0,c.jsx)("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"})});if(p)return(0,c.jsxs)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative",children:[(0,c.jsx)("strong",{className:"font-bold",children:"Error: "}),(0,c.jsx)("span",{className:"block sm:inline",children:p}),(0,c.jsx)("button",{onClick:()=>t("/devices"),className:"mt-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700",children:"Back to Devices"})]});if(!s)return(0,c.jsxs)("div",{className:"text-center py-8",children:[(0,c.jsx)("p",{className:"text-gray-600",children:"Device not found"}),(0,c.jsx)("button",{onClick:()=>t("/devices"),className:"mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700",children:"Back to Devices"})]});const w=void 0===(S=s.wifi_rssi)?{strength:"Unknown",color:"text-gray-600"}:S>=-50?{strength:"Excellent",color:"text-green-600"}:S>=-60?{strength:"Good",color:"text-green-500"}:S>=-70?{strength:"Fair",color:"text-yellow-600"}:{strength:"Poor",color:"text-red-600"};var S;return(0,c.jsxs)("div",{className:"container mx-auto px-4 py-6",children:[(0,c.jsxs)("div",{className:"mb-6",children:[(0,c.jsxs)("div",{className:"flex items-center justify-between",children:[(0,c.jsx)("div",{className:"flex items-center space-x-4",children:(0,c.jsxs)("button",{onClick:()=>t("/devices"),className:"text-blue-600 hover:text-blue-800 flex items-center",children:[(0,c.jsx)("svg",{className:"w-5 h-5 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,c.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Back to Devices"]})}),(0,c.jsx)("div",{className:"flex items-center space-x-2",children:(0,c.jsx)("span",{className:"px-3 py-1 rounded-full text-sm font-medium ".concat(N(s.status)),children:s.status})})]}),(0,c.jsxs)("h1",{className:"text-3xl font-bold text-gray-900 mt-4",children:["Device: ",s.device_serial]})]}),(0,c.jsxs)("div",{className:"mb-6 bg-white p-4 rounded-lg shadow",children:[(0,c.jsx)("h2",{className:"text-lg font-semibold mb-3",children:"Device Actions"}),(0,c.jsxs)("div",{className:"flex space-x-2",children:[(0,c.jsx)("button",{onClick:()=>j("reboot"),disabled:x||"offline"===s.status,className:"bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:x?"Sending...":"Reboot"}),(0,c.jsx)("button",{onClick:()=>j("factory_reset"),disabled:x||"offline"===s.status,className:"bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:x?"Sending...":"Factory Reset"}),(0,c.jsx)("button",{onClick:()=>j("sync_config"),disabled:x||"offline"===s.status,className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:x?"Sending...":"Sync Config"})]}),"offline"===s.status&&(0,c.jsx)("p",{className:"text-sm text-gray-600 mt-2",children:"Device actions are disabled when the device is offline."})]}),(0,c.jsx)("div",{className:"mb-6",children:(0,c.jsx)("div",{className:"border-b border-gray-200",children:(0,c.jsx)("nav",{className:"-mb-px flex space-x-8",children:["overview","ota","heartbeat"].map(e=>(0,c.jsx)("button",{onClick:()=>v(e),className:"py-2 px-1 border-b-2 font-medium text-sm ".concat(f===e?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:e.charAt(0).toUpperCase()+e.slice(1)},e))})})}),"overview"===f&&(0,c.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,c.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow",children:[(0,c.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"Basic Information"}),(0,c.jsxs)("div",{className:"space-y-3",children:[(0,c.jsxs)("div",{className:"flex justify-between",children:[(0,c.jsx)("span",{className:"text-gray-600",children:"Device Serial:"}),(0,c.jsx)("span",{className:"font-mono",children:s.device_serial})]}),(0,c.jsxs)("div",{className:"flex justify-between",children:[(0,c.jsx)("span",{className:"text-gray-600",children:"Customer:"}),(0,c.jsx)("span",{children:s.customer||"N/A"})]}),(0,c.jsxs)("div",{className:"flex justify-between",children:[(0,c.jsx)("span",{className:"text-gray-600",children:"Provisioned:"}),(0,c.jsx)("span",{children:new Date(s.provisioned_at).toLocaleDateString()})]}),(0,c.jsxs)("div",{className:"flex justify-between",children:[(0,c.jsx)("span",{className:"text-gray-600",children:"Config Version:"}),(0,c.jsx)("span",{children:s.config_version||"N/A"})]}),(0,c.jsxs)("div",{className:"flex justify-between",children:[(0,c.jsx)("span",{className:"text-gray-600",children:"Firmware Version:"}),(0,c.jsx)("span",{children:s.firmware_version||"N/A"})]})]})]}),(0,c.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow",children:[(0,c.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"Connectivity Status"}),(0,c.jsxs)("div",{className:"space-y-3",children:[(0,c.jsxs)("div",{className:"flex justify-between",children:[(0,c.jsx)("span",{className:"text-gray-600",children:"Status:"}),(0,c.jsx)("span",{className:"px-2 py-1 rounded text-sm ".concat(N(s.status)),children:s.status})]}),(0,c.jsxs)("div",{className:"flex justify-between",children:[(0,c.jsx)("span",{className:"text-gray-600",children:"Last Heartbeat:"}),(0,c.jsx)("span",{children:(e=>{if(!e)return"Never";const t=new Date,s=new Date(e),r=t.getTime()-s.getTime(),a=Math.floor(r/6e4);if(a<1)return"Just now";if(a<60)return"".concat(a," minutes ago");const n=Math.floor(a/60);if(n<24)return"".concat(n," hours ago");const c=Math.floor(n/24);return"".concat(c," days ago")})(s.last_heartbeat)})]}),(0,c.jsxs)("div",{className:"flex justify-between",children:[(0,c.jsx)("span",{className:"text-gray-600",children:"Uptime:"}),(0,c.jsx)("span",{children:s.uptime_formatted})]}),(0,c.jsxs)("div",{className:"flex justify-between",children:[(0,c.jsx)("span",{className:"text-gray-600",children:"WiFi Signal:"}),(0,c.jsx)("span",{className:"".concat(w.color),children:s.wifi_rssi?"".concat(s.wifi_rssi," dBm (").concat(w.strength,")"):"N/A"})]}),(0,c.jsxs)("div",{className:"flex justify-between",children:[(0,c.jsx)("span",{className:"text-gray-600",children:"Memory Usage:"}),(0,c.jsx)("span",{children:s.memory_usage?"".concat(s.memory_usage.toFixed(1),"%"):"N/A"})]})]})]})]}),"ota"===f&&(0,c.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow",children:[(0,c.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"OTA Update History"}),o.length>0?(0,c.jsx)("div",{className:"space-y-4",children:o.map(e=>(0,c.jsxs)("div",{className:"border rounded-lg p-4",children:[(0,c.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,c.jsx)("h3",{className:"font-medium",children:e.ota_update.name}),(0,c.jsx)("span",{className:"px-2 py-1 rounded text-sm ".concat(N(e.status)),children:e.status})]}),(0,c.jsxs)("div",{className:"text-sm text-gray-600 space-y-1",children:[(0,c.jsxs)("p",{children:["Version: ",e.target_version||e.ota_update.version]}),(0,c.jsxs)("p",{children:["Progress: ",e.progress_percentage,"%"]}),e.previous_version&&(0,c.jsxs)("p",{children:["Previous Version: ",e.previous_version]}),e.started_at&&(0,c.jsxs)("p",{children:["Started: ",new Date(e.started_at).toLocaleString()]}),e.completed_at&&(0,c.jsxs)("p",{children:["Completed: ",new Date(e.completed_at).toLocaleString()]}),e.error_message&&(0,c.jsxs)("p",{className:"text-red-600",children:["Error: ",e.error_message]})]})]},e.id))}):(0,c.jsx)("p",{className:"text-gray-600",children:"No OTA updates available for this device."})]}),"heartbeat"===f&&(0,c.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow",children:[(0,c.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"Heartbeat History"}),d.length>0?(0,c.jsx)("div",{className:"space-y-3",children:d.map((e,t)=>(0,c.jsx)("div",{className:"flex items-center justify-between p-3 border rounded",children:(0,c.jsxs)("div",{className:"flex-1",children:[(0,c.jsx)("p",{className:"text-sm font-medium",children:new Date(e.timestamp).toLocaleString()}),(0,c.jsxs)("div",{className:"text-xs text-gray-600 mt-1 space-x-4",children:[(0,c.jsxs)("span",{children:["Uptime: ",Math.floor(e.uptime_seconds/3600),"h ",Math.floor(e.uptime_seconds%3600/60),"m"]}),(0,c.jsxs)("span",{children:["Memory: ",e.memory_usage.toFixed(1),"%"]}),(0,c.jsxs)("span",{children:["WiFi: ",e.wifi_rssi," dBm"]})]})]})},t))}):(0,c.jsx)("p",{className:"text-gray-600",children:"No heartbeat history available for this device."})]})]})}},5560:(e,t,s)=>{s.d(t,{K:()=>o});var r=s(2555);class a{constructor(){this.cache=new Map}set(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:a.DEFAULT_TTL;this.cache.set(e,{data:t,timestamp:Date.now(),expiresIn:s})}get(e){const t=this.cache.get(e);if(!t)return null;return Date.now()-t.timestamp>t.expiresIn?(this.cache.delete(e),null):t.data}has(e){const t=this.cache.get(e);if(!t)return!1;return!(Date.now()-t.timestamp>t.expiresIn)||(this.cache.delete(e),!1)}clear(e){this.cache.delete(e)}clearAll(){this.cache.clear()}size(){return this.cache.size}static getTTL(){return"long"===(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"short")?a.LONG_TTL:a.DEFAULT_TTL}}a.DEFAULT_TTL=3e5,a.LONG_TTL=18e5;const n=new a,c=3e5,i="https://smart-solar-django-backend.vercel.app/api";const o=new class{getAuthHeaders(){const e=localStorage.getItem("authTokens");if(e)try{const t=JSON.parse(e);return{Authorization:"Bearer ".concat(t.access),"Content-Type":"application/json"}}catch(t){console.error("Error parsing auth tokens:",t)}return{"Content-Type":"application/json"}}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const s="".concat(i).concat(e);let a=this.getAuthHeaders(),n=await fetch(s,(0,r.A)((0,r.A)({},t),{},{headers:(0,r.A)((0,r.A)({},a),t.headers)}));if(401===n.status){await this.refreshToken()&&(a=this.getAuthHeaders(),n=await fetch(s,(0,r.A)((0,r.A)({},t),{},{headers:(0,r.A)((0,r.A)({},a),t.headers)})))}if(401===n.status)throw localStorage.removeItem("authTokens"),localStorage.removeItem("authUser"),window.location.href="/login",new Error("Authentication required");if(!n.ok){const e=await n.text();throw new Error("API request failed: ".concat(n.status," ").concat(n.statusText," - ").concat(e))}return n.json()}async refreshToken(){const e=localStorage.getItem("authTokens");if(!e)return!1;try{const t=JSON.parse(e),s=await fetch("".concat(i,"/auth/token/refresh/"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh:t.refresh})});if(s.ok){const e={access:(await s.json()).access,refresh:t.refresh};return localStorage.setItem("authTokens",JSON.stringify(e)),!0}}catch(t){console.error("Token refresh failed:",t)}return!1}async get(e){return await this.request(e,{method:"GET"})}async post(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const a=(0,r.A)({method:"POST"},s);if(!t||t instanceof FormData){if(t instanceof FormData){a.body=t;const e=(0,r.A)({},this.getAuthHeaders());delete e["Content-Type"],a.headers=(0,r.A)((0,r.A)({},e),s.headers)}}else a.body=JSON.stringify(t);return this.request(e,a)}async put(e,t){return this.request(e,{method:"PUT",body:t?JSON.stringify(t):void 0})}async delete(e){return this.request(e,{method:"DELETE"})}async getConfiguration(){return this.request("/config/")}async getTelemetry(){return this.request("/telemetry/")}async provisionDevice(e){const t=await fetch("".concat(i,"/devices/provision"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error("Provisioning failed: ".concat(t.statusText));return t.json()}async getAlerts(){const e="alerts",t=n.get(e);if(t)return t;const s=await this.request("/alerts/");return n.set(e,s,c),s}async getSystemHealth(){const e="system_health",t=n.get(e);if(t)return t;const s=await this.request("/health/");return n.set(e,s,c),s}async getKPIs(){const e="kpis",t=n.get(e);if(t)return t;const s=await this.request("/kpis/");return n.set(e,s,c),s}async getUsers(e){const t="users_".concat(e||"all"),s=n.get(t);if(s)return s;const r=e?"?search=".concat(encodeURIComponent(e)):"",a=await this.request("/users/".concat(r));return n.set(t,a,c),a}async createUser(e){const t=await this.request("/users/create/",{method:"POST",body:JSON.stringify(e)});return n.clear("users_all"),n.clearAll(),t}async createEmployee(e){const t=await this.request("/users/create/",{method:"POST",body:JSON.stringify((0,r.A)((0,r.A)({},e),{},{is_staff:!0}))});return n.clear("users_all"),t}async getUserDevices(e){return this.request("/users/".concat(e,"/devices/"))}async updateUser(e,t){const s=await this.request("/users/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)});return n.clear("users_all"),s}async deleteUser(e){const t=await this.request("/users/".concat(e,"/delete/"),{method:"DELETE"});return n.clear("users_all"),t}async getProfile(){return this.request("/profile/")}async updateProfile(e){return this.request("/profile/update/",{method:"PUT",body:JSON.stringify(e)})}async changePassword(e){return this.request("/profile/change-password/",{method:"POST",body:JSON.stringify(e)})}async getCustomers(e){const t=e?"?search=".concat(encodeURIComponent(e)):"";return this.request("/customers/".concat(t))}async createCustomer(e){return this.request("/customers/create/",{method:"POST",body:JSON.stringify(e)})}async getCustomer(e){return this.request("/customers/".concat(e,"/"))}async updateCustomer(e,t){return this.request("/customers/".concat(e,"/update/"),{method:"PUT",body:JSON.stringify(t)})}async deleteCustomer(e){return this.request("/customers/".concat(e,"/delete/"),{method:"DELETE"})}async getPresets(){const e="presets",t=n.get(e);if(t)return t;const s=await this.request("/presets/");return n.set(e,s,18e5),s}async createPreset(e){const t=await this.request("/presets/create/",{method:"POST",body:JSON.stringify(e)});return n.clear("presets"),t}async updatePreset(e,t){const s=await this.request("/presets/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)});return n.clear("presets"),s}async deletePreset(e){const t=await this.request("/presets/".concat(e,"/delete/"),{method:"DELETE"});return n.clear("presets"),t}async getDevices(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:25;const r=new URLSearchParams;e&&r.append("search",e),r.append("page",t.toString()),r.append("page_size",s.toString());const a=r.toString();return this.request("/devices/?".concat(a))}async createDevice(e){return this.request("/devices/create/",{method:"POST",body:JSON.stringify(e)})}async updateDevice(e,t){return this.request("/devices/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)})}async deleteDevice(e){return this.request("/devices/".concat(e,"/delete/"),{method:"DELETE"})}async deleteDevicesBulk(e){return this.request("/devices/delete-bulk/",{method:"POST",body:JSON.stringify({device_ids:e})})}async getSlaves(e){return this.request("/presets/".concat(e,"/slaves/"))}async createSlave(e,t){return this.request("/presets/".concat(e,"/slaves/create/"),{method:"POST",body:JSON.stringify(t)})}async updateSlave(e,t,s){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/"),{method:"PUT",body:JSON.stringify(s)})}async deleteSlave(e,t){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/delete/"),{method:"DELETE"})}}}}]);
//# sourceMappingURL=340.54717631.chunk.js.map