"use strict";(self.webpackChunksmart_solar_frontend=self.webpackChunksmart_solar_frontend||[]).push([[923],{7923(e,t,s){s.d(t,{OTA:()=>c});var a=s(2555),r=s(5043),n=s(5560),i=(s(4050),s(579));const c=()=>{const[e,t]=(0,r.useState)([]),[s,c]=(0,r.useState)(null),[o,l]=(0,r.useState)(null),[d,u]=(0,r.useState)(!1),[h,m]=(0,r.useState)(null),[f,p]=(0,r.useState)({version:"",description:"",release_notes:""}),[g,y]=(0,r.useState)(null),[v,b]=(0,r.useState)(""),[w,x]=(0,r.useState)("");(0,r.useEffect)(()=>{S()},[]);const S=async()=>{u(!0);try{const[e,s,a]=await Promise.all([n.K.getFirmwareVersions(!1),n.K.getOTAConfig(),n.K.getOTAHealth()]);t(e),c(s),y(s),l(a)}catch(e){x(e.message||"Failed to load OTA data")}finally{u(!1)}};return(0,i.jsxs)("div",{className:"admin-container",children:[(0,i.jsxs)("div",{className:"admin-header",children:[(0,i.jsx)("h1",{children:"Over-The-Air (OTA) Updates"}),(0,i.jsx)("div",{className:"health-status",children:o&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("span",{className:"status-badge status-badge-".concat("ok"===o.status?"success":"danger"),children:o.status.toUpperCase()}),(0,i.jsxs)("span",{className:"ml-2",children:[o.firmware_versions," versions (",o.active_firmware," active)"]})]})})]}),v&&(0,i.jsxs)("div",{className:"alert alert-success mt-3 fade-in",children:[v,(0,i.jsx)("button",{className:"alert-close",onClick:()=>b(""),children:"\xd7"})]}),w&&(0,i.jsxs)("div",{className:"alert alert-danger mt-3 fade-in",children:[w,(0,i.jsx)("button",{className:"alert-close",onClick:()=>x(""),children:"\xd7"})]}),d&&(0,i.jsx)("div",{className:"loading-spinner",children:"Loading OTA data..."}),(0,i.jsxs)("div",{className:"admin-grid",children:[(0,i.jsxs)("div",{className:"admin-card",children:[(0,i.jsx)("h2",{children:"Upload New Firmware"}),(0,i.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),h&&f.version)try{u(!0),x(""),b("");const e=new FormData;e.append("file",h),e.append("version",f.version),e.append("description",f.description||""),e.append("release_notes",f.release_notes||""),e.append("is_active","false"),await n.K.uploadFirmwareVersion(e),b("Firmware uploaded successfully"),m(null),p({version:"",description:"",release_notes:""});const t=document.querySelector(".ota-file-input");t&&(t.value=""),S()}catch(t){console.error("Upload error:",t),x(t.message||"Failed to upload firmware")}finally{u(!1)}else x("Please select a file and enter version number")},className:"form",children:[(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Version (e.g., 0x00020000)"}),(0,i.jsx)("input",{type:"text",className:"form-control",placeholder:"0x00020000",value:f.version,onChange:e=>p((0,a.A)((0,a.A)({},f),{},{version:e.target.value}))})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Firmware File"}),(0,i.jsx)("input",{type:"file",className:"form-control ota-file-input",accept:".bin,.hex,.elf",onChange:e=>{var t;null!==(t=e.target.files)&&void 0!==t&&t[0]&&m(e.target.files[0])}}),h&&(0,i.jsxs)("small",{className:"form-text",children:["File: ",h.name]})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Description"}),(0,i.jsx)("textarea",{className:"form-control",placeholder:"Brief description of this firmware version",rows:2,value:f.description,onChange:e=>p((0,a.A)((0,a.A)({},f),{},{description:e.target.value}))})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Release Notes"}),(0,i.jsx)("textarea",{className:"form-control",placeholder:"Detailed release notes and changelog",rows:3,value:f.release_notes,onChange:e=>p((0,a.A)((0,a.A)({},f),{},{release_notes:e.target.value}))})]}),(0,i.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:d,children:d?"Uploading...":"Upload Firmware"})]})]}),(0,i.jsxs)("div",{className:"admin-card",children:[(0,i.jsx)("h2",{children:"Firmware Versions"}),0===e.length?(0,i.jsx)("p",{className:"text-muted",children:"No firmware versions uploaded yet"}):(0,i.jsx)("div",{className:"firmware-list",children:e.map(e=>(0,i.jsxs)("div",{className:"firmware-item ".concat(e.is_active?"active":""),children:[(0,i.jsxs)("div",{className:"firmware-header",children:[(0,i.jsx)("span",{className:"version-badge ".concat(e.is_active?"active":"inactive"),children:e.version}),(0,i.jsx)("span",{className:"filename",children:e.filename}),(0,i.jsxs)("span",{className:"size",children:["(",(e.size/1024/1024).toFixed(2)," MB)"]})]}),e.description&&(0,i.jsx)("p",{className:"description",children:e.description}),(0,i.jsxs)("div",{className:"firmware-footer",children:[(0,i.jsxs)("small",{className:"text-muted",children:["Created: ",new Date(e.created_at).toLocaleDateString()]}),(0,i.jsxs)("div",{className:"firmware-actions",children:[(0,i.jsx)("button",{className:"btn btn-sm ".concat(e.is_active?"btn-danger":"btn-success"),onClick:()=>(async e=>{try{u(!0),await n.K.updateFirmwareVersion(e.id,{is_active:!e.is_active}),b("Firmware ".concat(e.is_active?"deactivated":"activated"," successfully")),S()}catch(t){x(t.message||"Failed to update firmware status")}finally{u(!1)}})(e),disabled:d,children:e.is_active?"Deactivate":"Activate"}),(0,i.jsx)("button",{className:"btn btn-sm btn-danger",onClick:()=>(async e=>{if(e.is_active)return void x("Cannot delete active firmware. Deactivate it first.");if(window.confirm("Are you sure you want to delete firmware version ".concat(e.version,"?\n\n")+"This will permanently delete the firmware file from storage.\n\nThis action cannot be undone."))try{u(!0),x(""),b(""),await n.K.deleteFirmwareVersion(e.id),b("Firmware version ".concat(e.version," deleted successfully")),S()}catch(t){x(t.message||"Failed to delete firmware")}finally{u(!1)}})(e),disabled:d||e.is_active,title:e.is_active?"Deactivate firmware before deleting":"Delete firmware",children:"Delete"})]})]}),e.release_notes&&(0,i.jsxs)("details",{className:"mt-2",children:[(0,i.jsx)("summary",{children:"Release Notes"}),(0,i.jsx)("p",{className:"release-notes",children:e.release_notes})]})]},e.id))})]}),(0,i.jsxs)("div",{className:"admin-card",children:[(0,i.jsx)("h2",{children:"OTA Configuration"}),g&&(0,i.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),g)try{u(!0),await n.K.updateOTAConfig(g),b("OTA configuration updated successfully"),c(g)}catch(t){x(t.message||"Failed to update configuration")}finally{u(!1)}},className:"form",children:[(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Update Strategy"}),(0,i.jsxs)("select",{className:"form-control",value:g.update_strategy,onChange:e=>y((0,a.A)((0,a.A)({},g),{},{update_strategy:e.target.value})),children:[(0,i.jsx)("option",{value:"immediate",children:"Immediate - Push updates immediately"}),(0,i.jsx)("option",{value:"scheduled",children:"Scheduled - Push during maintenance window"}),(0,i.jsx)("option",{value:"manual",children:"Manual - Wait for device to request"})]})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Max Concurrent Updates"}),(0,i.jsx)("input",{type:"number",className:"form-control",min:"1",max:"50",value:g.max_concurrent_updates,onChange:e=>y((0,a.A)((0,a.A)({},g),{},{max_concurrent_updates:parseInt(e.target.value)}))}),(0,i.jsx)("small",{className:"form-text",children:"Maximum number of devices updating simultaneously"})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Firmware Retention (days)"}),(0,i.jsx)("input",{type:"number",className:"form-control",min:"1",max:"365",value:g.firmware_retention_days,onChange:e=>y((0,a.A)((0,a.A)({},g),{},{firmware_retention_days:parseInt(e.target.value)}))}),(0,i.jsx)("small",{className:"form-text",children:"Keep old firmware files for this many days before cleanup"})]}),(0,i.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:d,children:d?"Saving...":"Save Configuration"})]})]}),(0,i.jsxs)("div",{className:"admin-card",children:[(0,i.jsx)("h2",{children:"OTA Update Strategy"}),(0,i.jsxs)("div",{className:"info-box",children:[(0,i.jsxs)("h4",{children:["Current Strategy: ",null===s||void 0===s?void 0:s.update_strategy.toUpperCase()]}),(0,i.jsxs)("ul",{children:[(0,i.jsxs)("li",{children:[(0,i.jsx)("strong",{children:"Immediate:"})," Updates offered to devices immediately when activated"]}),(0,i.jsxs)("li",{children:[(0,i.jsx)("strong",{children:"Scheduled:"})," Updates offered during configured maintenance windows"]}),(0,i.jsxs)("li",{children:[(0,i.jsx)("strong",{children:"Manual:"})," Devices must explicitly request updates via API"]})]}),(0,i.jsx)("h4",{className:"mt-3",children:"For STM32 Devices:"}),(0,i.jsxs)("code",{className:"code-block",children:["POST /ota/devices/{device_id}/check",(0,i.jsx)("br",{}),'With: {"device_id": "...", "firmware_version": "0x00010000"}']}),(0,i.jsx)("h4",{className:"mt-3",children:"Device Response Format:"}),(0,i.jsx)("pre",{className:"code-block",children:JSON.stringify({id:"fw_1",version:"0x00020000",size:1048576,url:"https://api.../ota/firmware/1/download",checksum:"sha256_hash",status:1},null,2)})]})]})]})]})}},5560(e,t,s){s.d(t,{K:()=>o});var a=s(2555);class r{constructor(){this.cache=new Map,this.subscribers=new Map}set(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:r.DEFAULT_TTL,a=arguments.length>3?arguments[3]:void 0;this.cache.set(e,{data:t,timestamp:Date.now(),expiresIn:s,staleTime:null!==a&&void 0!==a?a:Math.min(s/2,r.STALE_TIME)}),this.notifySubscribers(e,t)}get(e){const t=this.cache.get(e);if(!t)return null;return Date.now()-t.timestamp>t.expiresIn?(this.cache.delete(e),null):t.data}getWithStaleStatus(e){var t;const s=this.cache.get(e);if(!s)return null;const a=Date.now()-s.timestamp,r=a>s.expiresIn,n=a>(null!==(t=s.staleTime)&&void 0!==t?t:s.expiresIn/2);return r?(this.cache.delete(e),null):{data:s.data,isStale:n,isExpired:!1}}has(e){const t=this.cache.get(e);if(!t)return!1;return!(Date.now()-t.timestamp>t.expiresIn)||(this.cache.delete(e),!1)}isStale(e){var t;const s=this.cache.get(e);if(!s)return!0;return Date.now()-s.timestamp>(null!==(t=s.staleTime)&&void 0!==t?t:s.expiresIn/2)}clear(e){this.cache.delete(e)}clearPattern(e){const t="string"===typeof e?new RegExp(e):e,s=[];this.cache.forEach((e,a)=>{t.test(a)&&s.push(a)}),s.forEach(e=>this.cache.delete(e))}clearAll(){this.cache.clear()}size(){return this.cache.size}subscribe(e,t){this.subscribers.has(e)||this.subscribers.set(e,new Set);const s={callback:t};return this.subscribers.get(e).add(s),()=>{const t=this.subscribers.get(e);t&&(t.delete(s),0===t.size&&this.subscribers.delete(e))}}subscribePattern(e,t){const s="__pattern__".concat(e.source);this.subscribers.has(s)||this.subscribers.set(s,new Set);const a={callback:t,pattern:e};return this.subscribers.get(s).add(a),()=>{const e=this.subscribers.get(s);e&&(e.delete(a),0===e.size&&this.subscribers.delete(s))}}notifySubscribers(e,t){const s=this.subscribers.get(e);s&&s.forEach(s=>{try{s.callback(t)}catch(a){console.error("Cache subscriber error for key ".concat(e,":"),a)}}),this.subscribers.forEach((s,a)=>{a.startsWith("__pattern__")&&s.forEach(s=>{if(s.pattern&&s.pattern.test(e))try{s.callback(t)}catch(a){console.error("Cache pattern subscriber error for key ".concat(e,":"),a)}})})}keys(){return Array.from(this.cache.keys())}getStats(){return{size:this.cache.size,keys:this.keys(),subscribers:Array.from(this.subscribers.values()).reduce((e,t)=>e+t.size,0)}}static getTTL(){switch(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"short"){case"realtime":return r.REALTIME_TTL;case"long":return r.LONG_TTL;default:return r.DEFAULT_TTL}}}r.DEFAULT_TTL=3e5,r.LONG_TTL=18e5,r.REALTIME_TTL=1e4,r.STALE_TIME=3e4;const n=new r,i=3e5,c="https://smart-solar-django-backend.vercel.app/api";const o=new class{getAuthHeaders(){const e=localStorage.getItem("authTokens");if(e)try{const t=JSON.parse(e);return{Authorization:"Bearer ".concat(t.access),"Content-Type":"application/json"}}catch(t){console.error("Error parsing auth tokens:",t)}return{"Content-Type":"application/json"}}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const s="".concat(c).concat(e);let r=this.getAuthHeaders(),n=await fetch(s,(0,a.A)((0,a.A)({},t),{},{headers:(0,a.A)((0,a.A)({},r),t.headers)}));if(401===n.status){await this.refreshToken()&&(r=this.getAuthHeaders(),n=await fetch(s,(0,a.A)((0,a.A)({},t),{},{headers:(0,a.A)((0,a.A)({},r),t.headers)})))}if(401===n.status)throw localStorage.removeItem("authTokens"),localStorage.removeItem("authUser"),window.location.href="/login",new Error("Authentication required");if(!n.ok){const e=await n.text();throw new Error("API request failed: ".concat(n.status," ").concat(n.statusText," - ").concat(e))}return n.json()}async refreshToken(){const e=localStorage.getItem("authTokens");if(!e)return!1;try{const t=JSON.parse(e),s=await fetch("".concat(c,"/auth/token/refresh/"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh:t.refresh})});if(s.ok){const e={access:(await s.json()).access,refresh:t.refresh};return localStorage.setItem("authTokens",JSON.stringify(e)),!0}}catch(t){console.error("Token refresh failed:",t)}return!1}async getConfiguration(){return this.request("/config/")}async getTelemetry(){return this.request("/telemetry/")}async provisionDevice(e){const t=await fetch("".concat(c,"/devices/provision"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error("Provisioning failed: ".concat(t.statusText));return t.json()}async getAlerts(){const e="alerts",t=n.get(e);if(t)return t;const s=await this.request("/alerts/");return n.set(e,s,i),s}async getSystemHealth(){const e="system_health",t=n.get(e);if(t)return t;const s=await this.request("/health/");return n.set(e,s,i),s}async getKPIs(){const e="kpis",t=n.get(e);if(t)return t;const s=await this.request("/kpis/");return n.set(e,s,i),s}async getUsers(e){const t="users_".concat(e||"all"),s=n.get(t);if(s)return s;const a=e?"?search=".concat(encodeURIComponent(e)):"",r=await this.request("/users/".concat(a));return n.set(t,r,i),r}async createUser(e){const t=await this.request("/users/create/",{method:"POST",body:JSON.stringify(e)});return n.clear("users_all"),n.clearAll(),t}async createEmployee(e){const t=await this.request("/users/create/",{method:"POST",body:JSON.stringify((0,a.A)((0,a.A)({},e),{},{is_staff:!0}))});return n.clear("users_all"),t}async getUserDevices(e){return this.request("/users/".concat(e,"/devices/"))}async updateUser(e,t){const s=await this.request("/users/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)});return n.clear("users_all"),s}async deleteUser(e){const t=await this.request("/users/".concat(e,"/delete/"),{method:"DELETE"});return n.clear("users_all"),t}async getProfile(){return this.request("/profile/")}async updateProfile(e){return this.request("/profile/update/",{method:"PUT",body:JSON.stringify(e)})}async changePassword(e){return this.request("/profile/change-password/",{method:"POST",body:JSON.stringify(e)})}async getCustomers(e){const t=e?"?search=".concat(encodeURIComponent(e)):"";return this.request("/customers/".concat(t))}async createCustomer(e){return this.request("/customers/create/",{method:"POST",body:JSON.stringify(e)})}async getCustomer(e){return this.request("/customers/".concat(e,"/"))}async updateCustomer(e,t){return this.request("/customers/".concat(e,"/update/"),{method:"PUT",body:JSON.stringify(t)})}async deleteCustomer(e){return this.request("/customers/".concat(e,"/delete/"),{method:"DELETE"})}async getPresets(){const e="presets",t=n.get(e);if(t)return t;const s=await this.request("/presets/");return n.set(e,s,18e5),s}async createPreset(e){const t=await this.request("/presets/create/",{method:"POST",body:JSON.stringify(e)});return n.clear("presets"),t}async updatePreset(e,t){const s=await this.request("/presets/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)});return n.clear("presets"),s}async deletePreset(e){const t=await this.request("/presets/".concat(e,"/delete/"),{method:"DELETE"});return n.clear("presets"),t}async getGlobalSlaves(){return this.request("/slaves/")}async createGlobalSlave(e){return this.request("/slaves/create/",{method:"POST",body:JSON.stringify(e)})}async updateGlobalSlave(e,t){return this.request("/slaves/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)})}async deleteGlobalSlave(e){return this.request("/slaves/".concat(e,"/delete/"),{method:"DELETE"})}async getDevices(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:25;const a=new URLSearchParams;e&&a.append("search",e),a.append("page",t.toString()),a.append("page_size",s.toString());const r=a.toString();return this.request("/devices/?".concat(r))}async createDevice(e){return this.request("/devices/create/",{method:"POST",body:JSON.stringify(e)})}async updateDevice(e,t){return this.request("/devices/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)})}async deleteDevice(e){return this.request("/devices/".concat(e,"/delete/"),{method:"DELETE"})}async deleteDevicesBulk(e){return this.request("/devices/delete-bulk/",{method:"POST",body:JSON.stringify({device_ids:e})})}async getSlaves(e){return this.request("/presets/".concat(e,"/slaves/"))}async createSlave(e,t){return this.request("/presets/".concat(e,"/slaves/create/"),{method:"POST",body:JSON.stringify(t)})}async updateSlave(e,t,s){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/"),{method:"PUT",body:JSON.stringify(s)})}async deleteSlave(e,t){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/delete/"),{method:"DELETE"})}async addSlavesToPreset(e,t){return this.request("/presets/".concat(e,"/slaves/add/"),{method:"POST",body:JSON.stringify({slave_ids:t})})}async detachSlaveFromPreset(e,t){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/detach/"),{method:"POST"})}async getFirmwareVersions(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=new URLSearchParams;return t.append("active",e.toString()),this.request("/ota/firmware/?".concat(t.toString()))}async uploadFirmwareVersion(e){const t="".concat(c,"/ota/firmware/create/"),s=localStorage.getItem("authTokens");if(!s)throw new Error("Authentication required");const a=JSON.parse(s);let r={Authorization:"Bearer ".concat(a.access)},n=await fetch(t,{method:"POST",headers:r,body:e});if(401===n.status){if(await this.refreshToken()){const s=JSON.parse(localStorage.getItem("authTokens")||"{}");r={Authorization:"Bearer ".concat(s.access)},n=await fetch(t,{method:"POST",headers:r,body:e})}}if(401===n.status)throw localStorage.removeItem("authTokens"),localStorage.removeItem("authUser"),window.location.href="/login",new Error("Authentication required");if(!n.ok){const e=await n.text();throw new Error("Upload failed: ".concat(n.status," ").concat(n.statusText," - ").concat(e))}return n.json()}async updateFirmwareVersion(e,t){return this.request("/ota/firmware/".concat(e,"/"),{method:"PATCH",body:JSON.stringify(t)})}async deleteFirmwareVersion(e){return this.request("/ota/firmware/".concat(e,"/delete/"),{method:"DELETE"})}async getDeviceUpdateLogs(e){return this.request("/ota/devices/".concat(e,"/logs"))}async getOTAConfig(){return this.request("/ota/config/")}async updateOTAConfig(e){return this.request("/ota/config/update/",{method:"PATCH",body:JSON.stringify(e)})}async getOTAHealth(){return this.request("/ota/health/")}}}}]);
//# sourceMappingURL=923.c35502ad.chunk.js.map