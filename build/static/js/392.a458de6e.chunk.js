"use strict";(self.webpackChunksmart_solar_frontend=self.webpackChunksmart_solar_frontend||[]).push([[392],{9550(e,t,s){s.d(t,{A:()=>i});var r=s(5043),a=s(579);const n=e=>{let{createdBy:t,createdAt:s,updatedBy:r,updatedAt:n,className:i="audit-trail"}=e;const o=e=>{if(!e)return"N/A";try{return new Date(e).toLocaleString()}catch(t){return e}};return(0,a.jsxs)("div",{className:i,children:[(0,a.jsxs)("div",{className:"audit-row",children:[(0,a.jsx)("span",{className:"audit-label",children:"Created:"}),t?(0,a.jsxs)("span",{className:"audit-value",children:["by ",(0,a.jsx)("strong",{children:t})," on ",o(s)]}):(0,a.jsx)("span",{className:"audit-value",children:"System"})]}),r&&(0,a.jsxs)("div",{className:"audit-row",children:[(0,a.jsx)("span",{className:"audit-label",children:"Last Updated:"}),(0,a.jsxs)("span",{className:"audit-value",children:["by ",(0,a.jsx)("strong",{children:r})," on ",o(n)]})]})]})},i=r.memo(n)},392(e,t,s){s.r(t),s.d(t,{default:()=>d});var r=s(2555),a=s(5043),n=s(5475),i=s(5560);function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:300;const[s,r]=(0,a.useState)(null),n=(0,a.useCallback)(function(){for(var a=arguments.length,n=new Array(a),i=0;i<a;i++)n[i]=arguments[i];s&&clearTimeout(s);const o=setTimeout(()=>{e(...n)},t);r(o)},[e,t,s]);return(0,a.useEffect)(()=>()=>{s&&clearTimeout(s)},[s]),n}var c=s(9550),l=s(579);const d=()=>{var e,t;const[s]=(0,n.ok)(),[d,u]=(0,a.useState)([]),[h,p]=(0,a.useState)([]),[g,m]=(0,a.useState)(!0),[v,x]=(0,a.useState)(null),[f,y]=(0,a.useState)(null),[b,j]=(0,a.useState)(!1),[S,w]=(0,a.useState)(""),[A,_]=(0,a.useState)(""),[N,T]=(0,a.useState)([]),[C,k]=(0,a.useState)(!1),[D,E]=(0,a.useState)([]),[L,P]=(0,a.useState)(new Set),[q,O]=(0,a.useState)(!1),[I,z]=(0,a.useState)(1),[U,J]=(0,a.useState)(25),[M,B]=(0,a.useState)(0),[R,F]=(0,a.useState)(0),[H,V]=(0,a.useState)([]),[K,W]=(0,a.useState)(!0),[G,Y]=(0,a.useState)(null),[Q,X]=(0,a.useState)(null),[Z,$]=(0,a.useState)([]),[ee,te]=(0,a.useState)(null),[se,re]=(0,a.useState)(null),[ae,ne]=(0,a.useState)({device_serial:"",user:"",config_version:""}),[ie,oe]=(0,a.useState)({device_serial:"",user:"",config_version:""}),ce=(0,a.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";try{m(!0);const s=await i.K.getDevices(t||void 0,e,U);s.results?(u(s.results),p(s.results),B(s.count),F(s.total_pages),z(s.current_page)):(u(Array.isArray(s)?s:[]),p(Array.isArray(s)?s:[]),B(Array.isArray(s)?s.length:0),F(1),z(1)),m(!1)}catch(s){x(s instanceof Error?s.message:"An error occurred"),m(!1)}},[U]);(0,a.useEffect)(()=>{(async()=>{try{const e=(await i.K.getUsers()).filter(e=>!e.is_staff&&!e.is_superuser);E(e)}catch(e){console.error("Failed to fetch users:",e),x("Failed to load users for device assignment")}})(),(async()=>{try{const e=await i.K.getPresets();V(Array.isArray(e)?e:[])}catch(e){console.error("Failed to fetch presets:",e)}finally{W(!1)}})(),(async()=>{try{const[e,t]=await Promise.all([i.K.getSystemHealth(),i.K.getTelemetry()]);Y(e||null);const s=Array.isArray(t)?t:[];$(s);const r=s.reduce((e,t)=>{if(null===t||void 0===t||!t.timestamp)return e;const s=new Date(t.timestamp);return Number.isNaN(s.getTime())?e:e?s>new Date(e)?t.timestamp:e:t.timestamp},null),a=new Set(s.map(e=>e.deviceId)).size;X({totalPoints:s.length,deviceCount:a,latestTimestamp:r})}catch(e){console.error("Failed to fetch dashboard data:",e),te("Failed to load device dashboards")}})()},[]),(0,a.useEffect)(()=>{const e=s.get("deviceId");if(e){const t=parseInt(e,10);if(!isNaN(t)){const e=d.find(e=>e.id===t);e&&re(e)}}},[s,d]),(0,a.useEffect)(()=>{ce(I,S)},[I,S,U,ce]),(0,a.useEffect)(()=>{const e=()=>{k(!1)};return C&&document.addEventListener("click",e),()=>{document.removeEventListener("click",e)}},[C]),(0,a.useEffect)(()=>{if(""===A.trim())T(D);else{const e=A.toLowerCase(),t=D.filter(t=>{const s="".concat(t.first_name," ").concat(t.last_name).toLowerCase();return t.username.toLowerCase().includes(e)||t.first_name.toLowerCase().includes(e)||t.last_name.toLowerCase().includes(e)||s.includes(e)||t.email.toLowerCase().includes(e)});T(t)}},[D,A]);const le=o(e=>{},300),de=e=>{var t,s;y(e),ne({device_serial:e.device_serial,user:e.user||"",config_version:e.config_version||""}),_(e.user?"".concat(null===(t=D.find(t=>t.username===e.user))||void 0===t?void 0:t.first_name," ").concat(null===(s=D.find(t=>t.username===e.user))||void 0===s?void 0:s.last_name," (").concat(e.user,")"):""),k(!1)},ue=async()=>{if(f)try{await i.K.updateDevice(f.id,ae),y(null),await ce(I,S)}catch(e){x(e instanceof Error?e.message:"Failed to update device")}},he=async()=>{try{await i.K.createDevice(ie),j(!1),oe({device_serial:"",user:"",config_version:""}),await ce(I,S)}catch(e){x(e instanceof Error?e.message:"Failed to create device")}},pe=()=>{y(null),j(!1),_(""),k(!1)},ge=()=>{re(null)};if(g)return(0,l.jsx)("div",{className:"loading",children:"Loading devices..."});if(v)return(0,l.jsxs)("div",{className:"error",children:["Error: ",v]});const me=e=>{var t,s;return(null===(t=e.gateway_configuration)||void 0===t||null===(s=t.general_settings)||void 0===s?void 0:s.config_id)||e.config_id||""};if(se){const e=Z.filter(e=>e.deviceId===se.device_serial),t=e.reduce((e,t)=>{if(null===t||void 0===t||!t.timestamp)return e;const s=new Date(t.timestamp);if(Number.isNaN(s.getTime()))return e;if(!e)return t.timestamp;return s>new Date(e)?t.timestamp:e},null);return(0,l.jsxs)("div",{children:[(0,l.jsxs)("div",{style:{display:"flex",alignItems:"center",marginBottom:"20px"},children:[(0,l.jsx)("button",{onClick:ge,className:"btn btn-secondary",style:{marginRight:"15px"},children:"\u2190 Back to Devices"}),(0,l.jsxs)("h1",{style:{margin:0},children:[se.device_serial," Dashboard"]})]}),(0,l.jsxs)("div",{className:"card",style:{marginBottom:"20px"},children:[(0,l.jsxs)("div",{className:"card-header",children:[(0,l.jsx)("h2",{children:"Device Details"}),(0,l.jsx)("button",{onClick:()=>de(se),className:"btn",children:"Edit Device"})]}),(0,l.jsx)("div",{style:{padding:"20px"},children:(0,l.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"15px"},children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:"Assigned User:"}),(0,l.jsx)("p",{style:{margin:"5px 0"},children:se.user||"-"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:"Config Version:"}),(0,l.jsx)("p",{style:{margin:"5px 0"},children:se.config_version||"-"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:"Provisioned At:"}),(0,l.jsx)("p",{style:{margin:"5px 0"},children:se.provisioned_at?new Date(se.provisioned_at).toLocaleDateString():"N/A"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("strong",{children:"Created By:"}),(0,l.jsx)("p",{style:{margin:"5px 0"},children:se.created_by_username||"-"})]})]})})]}),(0,l.jsxs)("div",{className:"grid grid-cols-2",style:{gap:"var(--space-6, 24px)"},children:[(0,l.jsxs)("div",{className:"card",children:[(0,l.jsx)("h2",{children:"System Health"}),ee&&(0,l.jsx)("p",{className:"error",children:ee}),!ee&&!G&&(0,l.jsx)("p",{children:"Loading system health..."}),G&&(0,l.jsxs)("div",{children:[(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:"Overall:"})," ",G.overall_health]}),(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:"Devices:"})," ",G.active_devices,"/",G.total_devices," active"]}),(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:"Telemetry Points:"})," ",G.total_telemetry_points.toLocaleString()]})]})]}),(0,l.jsxs)("div",{className:"card",children:[(0,l.jsx)("h2",{children:"Telemetry Snapshot"}),ee&&(0,l.jsx)("p",{className:"error",children:ee}),!ee&&!Q&&(0,l.jsx)("p",{children:"Loading telemetry..."}),Q&&(0,l.jsxs)("div",{children:[(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:"Total Points:"})," ",e.length.toLocaleString()]}),(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:"Data Types:"})," ",new Set(e.map(e=>e.data_type)).size]}),(0,l.jsxs)("p",{children:[(0,l.jsx)("strong",{children:"Latest:"})," ",t?new Date(t).toLocaleString():"N/A"]})]})]})]}),f&&(0,l.jsx)("div",{className:"modal",children:(0,l.jsxs)("div",{className:"modal-content",children:[(0,l.jsx)("h3",{children:f?"Edit Device: ".concat(f.device_serial):"Register New Device"}),(0,l.jsxs)("form",{onSubmit:e=>{e.preventDefault(),f?ue():he()},children:[(0,l.jsxs)("div",{className:"modal-body",children:[(0,l.jsxs)("div",{className:"form-section",children:[(0,l.jsx)("h4",{className:"form-section-title",children:"Device Identity"}),(0,l.jsx)("div",{className:"form-grid",children:(0,l.jsxs)("div",{className:"form-group",children:[(0,l.jsx)("label",{children:"Device Serial Number"}),(0,l.jsx)("input",{type:"text",value:f?ae.device_serial:ie.device_serial,onChange:e=>f?ne((0,r.A)((0,r.A)({},ae),{},{device_serial:e.target.value})):oe((0,r.A)((0,r.A)({},ie),{},{device_serial:e.target.value})),required:!0,autoComplete:"off",placeholder:"SN-12345678"})]})})]}),(0,l.jsxs)("div",{className:"form-section",children:[(0,l.jsx)("h4",{className:"form-section-title",children:"Ownership & Assignment"}),(0,l.jsx)("div",{className:"form-grid",children:(0,l.jsxs)("div",{className:"form-group",children:[(0,l.jsx)("label",{children:"Assigned User"}),(0,l.jsxs)("div",{style:{position:"relative"},onClick:e=>e.stopPropagation(),children:[(0,l.jsx)("input",{type:"text",placeholder:"Search by name, username, or email...",value:A,onChange:e=>{_(e.target.value),k(!0)},onFocus:()=>k(!0),autoComplete:"off",className:"full-width"}),C&&(0,l.jsx)("div",{style:{position:"absolute",top:"100%",left:"0",right:"0",background:"var(--bg-secondary, #1e293b)",border:"1px solid var(--border-color, rgba(148, 163, 184, 0.2))",borderRadius:"6px",marginTop:"4px",maxHeight:"200px",overflowY:"auto",zIndex:10,boxShadow:"0 4px 12px rgba(0, 0, 0, 0.3)"},children:N.length>0?N.map(e=>(0,l.jsxs)("div",{onClick:()=>{f?ne((0,r.A)((0,r.A)({},ae),{},{user:e.username})):oe((0,r.A)((0,r.A)({},ie),{},{user:e.username})),_("".concat(e.first_name," ").concat(e.last_name," (").concat(e.username,")")),k(!1)},style:{padding:"12px 16px",cursor:"pointer",borderBottom:"1px solid var(--border-color, rgba(148, 163, 184, 0.1))",background:(f?ae.user:ie.user)===e.username?"rgba(99, 102, 241, 0.15)":"transparent",color:"var(--text-primary, #f8fafc)",transition:"all 0.15s ease",fontSize:"0.875rem"},onMouseEnter:e=>e.currentTarget.style.background="rgba(255, 255, 255, 0.06)",onMouseLeave:t=>t.currentTarget.style.background=(f?ae.user:ie.user)===e.username?"rgba(99, 102, 241, 0.15)":"transparent",children:[e.first_name," ",e.last_name," (",e.username,") ",(0,l.jsx)("br",{}),(0,l.jsx)("span",{style:{fontSize:"0.75rem",color:"var(--text-secondary, #94a3b8)"},children:e.email})]},e.id)):(0,l.jsx)("div",{style:{padding:"12px 16px",color:"var(--text-muted, #64748b)",fontSize:"0.875rem"},children:""===A.trim()?"Start typing to search users...":"No users found"})})]})]})})]}),(0,l.jsxs)("div",{className:"form-section",children:[(0,l.jsx)("h4",{className:"form-section-title",children:"Configuration"}),(0,l.jsxs)("div",{className:"form-grid form-grid-2",children:[(0,l.jsxs)("div",{className:"form-group",children:[(0,l.jsx)("label",{children:"Preset Template"}),(0,l.jsxs)("select",{value:f?ae.config_version:ie.config_version,onChange:e=>f?ne((0,r.A)((0,r.A)({},ae),{},{config_version:e.target.value})):oe((0,r.A)((0,r.A)({},ie),{},{config_version:e.target.value})),className:"full-width",children:[(0,l.jsx)("option",{value:"",children:"-- Manual Configuration --"}),K&&(0,l.jsx)("option",{value:"",disabled:!0,children:"Loading presets..."}),!K&&H.map(e=>(0,l.jsxs)("option",{value:me(e),children:[e.name," (",me(e)||"no ID",")"]},e.id))]}),(0,l.jsx)("small",{className:"form-hint",children:"Selecting a preset sets the Config Version ID below."})]}),(0,l.jsxs)("div",{className:"form-group",children:[(0,l.jsx)("label",{children:"Config Version ID"}),(0,l.jsx)("input",{type:"text",value:f?ae.config_version:ie.config_version,onChange:e=>f?ne((0,r.A)((0,r.A)({},ae),{},{config_version:e.target.value})):oe((0,r.A)((0,r.A)({},ie),{},{config_version:e.target.value})),autoComplete:"off",placeholder:"Manual Config ID"})]})]})]})]}),f&&(0,l.jsx)("div",{style:{padding:"0 24px"},children:(0,l.jsx)(c.A,{createdBy:f.created_by_username,createdAt:f.created_at,updatedBy:f.updated_by_username,updatedAt:f.updated_at})}),(0,l.jsxs)("div",{className:"form-actions",style:{padding:"0 24px 24px 24px"},children:[(0,l.jsx)("button",{type:"submit",className:"btn",children:f?"Save Changes":"Create Device"}),(0,l.jsx)("button",{type:"button",onClick:pe,className:"btn btn-secondary",children:"Cancel"})]})]})]})})]})}return(0,l.jsxs)("div",{children:[(0,l.jsx)("h1",{children:"Device Management"}),(0,l.jsxs)("div",{className:"card",children:[(0,l.jsxs)("div",{className:"card-header",children:[(0,l.jsxs)("h2",{children:["Devices (",h.length,")"]}),(0,l.jsxs)("div",{className:"card-actions",children:[(0,l.jsx)("input",{type:"text",placeholder:"Search devices...",value:S,onChange:e=>{const t=e.target.value;w(t),z(1),le(t)},className:"search-input"}),L.size>0&&(0,l.jsx)("button",{onClick:async()=>{if(0===L.size)return void x("No devices selected for deletion");const e=Array.from(L).map(e=>d.find(t=>t.id===e)).filter(Boolean),t="Are you sure you want to delete ".concat(L.size," device(s)?\n\n").concat(e.map(e=>null===e||void 0===e?void 0:e.device_serial).join(", "));if(window.confirm(t))try{O(!0),await i.K.deleteDevicesBulk(Array.from(L));const e=d.filter(e=>!L.has(e.id));u(e),p(e.filter(e=>e.device_serial.toLowerCase().includes(S.toLowerCase()))),P(new Set),O(!1)}catch(s){O(!1),console.error("Bulk delete error:",s),x(s instanceof Error?s.message:"Failed to delete devices")}},disabled:q,style:{background:"var(--danger-color, #ef4444)",color:"white",border:"none",padding:"8px 16px",borderRadius:"6px",cursor:q?"not-allowed":"pointer",fontSize:"0.875rem",fontWeight:"500",opacity:q?"0.6":"1"},children:q?"Deleting ".concat(L.size,"..."):"Delete Selected (".concat(L.size,")")}),(0,l.jsx)("button",{onClick:()=>{j(!0),_(""),k(!1)},className:"btn",children:"Register New Device"})]})]}),(0,l.jsxs)("table",{className:"table",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{style:{textAlign:"center",width:"40px"},children:(0,l.jsx)("input",{type:"checkbox",checked:L.size===h.length&&h.length>0,onChange:()=>{if(L.size===h.length)P(new Set);else{const e=new Set(h.map(e=>e.id));P(e)}},title:"Select all displayed devices"})}),(0,l.jsx)("th",{style:{textAlign:"center"},children:"Device Serial"}),(0,l.jsx)("th",{style:{textAlign:"center"},children:"Assigned To"}),(0,l.jsx)("th",{style:{textAlign:"center"},children:"Created By"}),(0,l.jsx)("th",{style:{textAlign:"center"},children:"Config Version"}),(0,l.jsx)("th",{style:{textAlign:"center"},children:"Provisioned At"}),(0,l.jsx)("th",{style:{textAlign:"center"},children:"Actions"})]})}),(0,l.jsx)("tbody",{children:h.map(e=>(0,l.jsxs)("tr",{onClick:()=>(e=>{re(e)})(e),style:{background:L.has(e.id)?"rgba(99, 102, 241, 0.1)":"transparent",cursor:"pointer"},className:"clickable-row",children:[(0,l.jsx)("td",{style:{textAlign:"center"},children:(0,l.jsx)("input",{type:"checkbox",checked:L.has(e.id),onChange:()=>(e=>{const t=new Set(L);t.has(e)?t.delete(e):t.add(e),P(t)})(e.id)})}),(0,l.jsx)("td",{style:{textAlign:"center"},children:e.device_serial}),(0,l.jsx)("td",{style:{textAlign:"center"},children:e.user||"-"}),(0,l.jsx)("td",{style:{textAlign:"center",fontSize:"0.875rem",color:"var(--text-secondary, #94a3b8)"},children:e.created_by_username||"-"}),(0,l.jsx)("td",{style:{textAlign:"center"},children:e.config_version||"-"}),(0,l.jsx)("td",{style:{textAlign:"center"},children:(()=>{if(!e.provisioned_at)return"N/A";const t=new Date(e.provisioned_at);return isNaN(t.getTime())?"Invalid Date":t.toLocaleDateString()})()}),(0,l.jsxs)("td",{style:{textAlign:"center"},children:[(0,l.jsx)("button",{onClick:t=>{t.stopPropagation(),de(e)},style:{background:"none",border:"none",cursor:"pointer",color:"var(--text-secondary, #94a3b8)",margin:"0 6px"},title:"Edit",children:(0,l.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),(0,l.jsx)("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]})}),(0,l.jsx)("button",{onClick:t=>{t.stopPropagation(),(async e=>{if(window.confirm("Are you sure you want to delete device ".concat(e.device_serial,"?")))try{await i.K.deleteDevice(e.id);const t=d.filter(t=>t.id!==e.id);u(t),p(t)}catch(t){console.error("Delete error:",t),x(t instanceof Error?t.message:"Failed to delete device")}})(e)},style:{background:"none",border:"none",cursor:"pointer",color:"var(--danger-color, #ef4444)",margin:"0 6px"},title:"Delete",children:(0,l.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("polyline",{points:"3,6 5,6 21,6"}),(0,l.jsx)("path",{d:"M19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"}),(0,l.jsx)("line",{x1:"10",y1:"11",x2:"10",y2:"17"}),(0,l.jsx)("line",{x1:"14",y1:"11",x2:"14",y2:"17"})]})})]})]},e.id))})]}),M>0&&(0,l.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"16px",borderTop:"1px solid var(--border-color, rgba(148, 163, 184, 0.1))",gap:"16px"},children:[(0,l.jsxs)("div",{style:{fontSize:"0.875rem",color:"var(--text-secondary, #94a3b8)"},children:["Showing ",(I-1)*U+1," - ",Math.min(I*U,M)," of ",M," devices"]}),(0,l.jsxs)("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[(0,l.jsx)("button",{onClick:()=>z(Math.max(1,I-1)),disabled:1===I,style:{padding:"8px 12px",border:"1px solid var(--border-color, rgba(148, 163, 184, 0.2))",borderRadius:"6px",background:1===I?"rgba(148, 163, 184, 0.1)":"transparent",color:"var(--text-primary, #f8fafc)",cursor:1===I?"not-allowed":"pointer",opacity:1===I?"0.5":"1"},children:"\u2190 Previous"}),(0,l.jsx)("div",{style:{display:"flex",gap:"4px",alignItems:"center"},children:(()=>{const e=[];for(let s=1;s<=R;s++){var t;1===s||s===R||Math.abs(s-I)<=1?e.push((0,l.jsx)("button",{onClick:()=>z(s),style:{padding:"6px 10px",border:"1px solid var(--border-color, rgba(148, 163, 184, 0.2))",borderRadius:"4px",background:s===I?"rgba(99, 102, 241, 0.2)":"transparent",color:"var(--text-primary, #f8fafc)",cursor:"pointer",fontWeight:s===I?"bold":"normal",minWidth:"32px"},children:s},s)):(null===(t=e[e.length-1])||void 0===t?void 0:t.key)!=="ellipsis-"+Math.floor(s/10)&&e.push((0,l.jsx)("span",{style:{padding:"0 4px",color:"var(--text-secondary, #94a3b8)"},children:"..."},"ellipsis-".concat(Math.floor(s/10))))}return e})()}),(0,l.jsx)("button",{onClick:()=>z(Math.min(R,I+1)),disabled:I===R,style:{padding:"8px 12px",border:"1px solid var(--border-color, rgba(148, 163, 184, 0.2))",borderRadius:"6px",background:I===R?"rgba(148, 163, 184, 0.1)":"transparent",color:"var(--text-primary, #f8fafc)",cursor:I===R?"not-allowed":"pointer",opacity:I===R?"0.5":"1"},children:"Next \u2192"})]}),(0,l.jsxs)("select",{value:U,onChange:e=>{J(parseInt(e.target.value)),z(1)},style:{padding:"8px",border:"1px solid var(--border-color, rgba(148, 163, 184, 0.2))",borderRadius:"6px",background:"var(--bg-primary, #0f172a)",color:"var(--text-primary, #f8fafc)",cursor:"pointer",fontSize:"0.875rem"},children:[(0,l.jsx)("option",{value:10,children:"10 per page"}),(0,l.jsx)("option",{value:25,children:"25 per page"}),(0,l.jsx)("option",{value:50,children:"50 per page"}),(0,l.jsx)("option",{value:100,children:"100 per page"})]})]})]}),(f||b)&&(0,l.jsx)("div",{className:"modal",children:(0,l.jsxs)("div",{className:"modal-content",children:[(0,l.jsx)("h3",{children:f?"Edit Device: ".concat(f.device_serial):"Register New Device"}),(0,l.jsxs)("form",{onSubmit:e=>{e.preventDefault(),f?ue():he()},children:[(0,l.jsxs)("div",{className:"modal-body",children:[(0,l.jsxs)("div",{className:"form-section",children:[(0,l.jsx)("h4",{className:"form-section-title",children:"Device Identity"}),(0,l.jsx)("div",{className:"form-grid",children:(0,l.jsxs)("div",{className:"form-group",children:[(0,l.jsx)("label",{children:"Device Serial Number"}),(0,l.jsx)("input",{type:"text",value:f?ae.device_serial:ie.device_serial,onChange:e=>f?ne((0,r.A)((0,r.A)({},ae),{},{device_serial:e.target.value})):oe((0,r.A)((0,r.A)({},ie),{},{device_serial:e.target.value})),required:!0,autoComplete:"off",placeholder:"SN-12345678"})]})})]}),(0,l.jsxs)("div",{className:"form-section",children:[(0,l.jsx)("h4",{className:"form-section-title",children:"Ownership & Assignment"}),(0,l.jsx)("div",{className:"form-grid",children:(0,l.jsxs)("div",{className:"form-group",children:[(0,l.jsx)("label",{children:"Assigned User"}),(0,l.jsxs)("div",{style:{position:"relative"},onClick:e=>e.stopPropagation(),children:[(0,l.jsx)("input",{type:"text",placeholder:"Search and select user...",value:A,onChange:e=>{_(e.target.value),k(!0)},onFocus:()=>k(!0),autoComplete:"off"}),(f?ae.user:ie.user)&&(0,l.jsxs)("div",{style:{marginTop:"8px",fontSize:"0.875rem",color:"var(--text-secondary, #94a3b8)"},children:[(0,l.jsx)("strong",{children:"Selected:"})," ",null===(e=D.find(e=>e.username===(f?ae.user:ie.user)))||void 0===e?void 0:e.first_name," ",null===(t=D.find(e=>e.username===(f?ae.user:ie.user)))||void 0===t?void 0:t.last_name," (",f?ae.user:ie.user,")",(0,l.jsx)("button",{type:"button",onClick:()=>{f?ne((0,r.A)((0,r.A)({},ae),{},{user:""})):oe((0,r.A)((0,r.A)({},ie),{},{user:""})),_("")},className:"btn-icon btn-icon-danger",style:{marginLeft:"10px"},title:"Remove Assignment",children:"\u2715"})]}),C&&(0,l.jsx)("div",{style:{position:"absolute",top:"100%",left:0,right:0,background:"var(--bg-secondary, #0f172a)",border:"1px solid var(--border-color, rgba(148, 163, 184, 0.1))",borderRadius:"8px",maxHeight:"200px",overflowY:"auto",zIndex:1e3,boxShadow:"var(--shadow-xl)",marginTop:"4px"},children:N.length>0?N.map(e=>(0,l.jsxs)("div",{onClick:()=>{f?ne((0,r.A)((0,r.A)({},ae),{},{user:e.username})):oe((0,r.A)((0,r.A)({},ie),{},{user:e.username})),_("".concat(e.first_name," ").concat(e.last_name," (").concat(e.username,")")),k(!1)},style:{padding:"12px 16px",cursor:"pointer",borderBottom:"1px solid var(--border-color, rgba(148, 163, 184, 0.1))",background:(f?ae.user:ie.user)===e.username?"rgba(99, 102, 241, 0.15)":"transparent",color:"var(--text-primary, #f8fafc)",transition:"all 0.15s ease",fontSize:"0.875rem"},onMouseEnter:e=>e.currentTarget.style.background="rgba(255, 255, 255, 0.06)",onMouseLeave:t=>t.currentTarget.style.background=(f?ae.user:ie.user)===e.username?"rgba(99, 102, 241, 0.15)":"transparent",children:[e.first_name," ",e.last_name," (",e.username,") ",(0,l.jsx)("br",{}),(0,l.jsx)("span",{style:{fontSize:"0.75rem",color:"var(--text-secondary, #94a3b8)"},children:e.email})]},e.id)):(0,l.jsx)("div",{style:{padding:"12px 16px",color:"var(--text-muted, #64748b)",fontSize:"0.875rem"},children:""===A.trim()?"Start typing to search users...":"No users found"})})]})]})})]}),(0,l.jsxs)("div",{className:"form-section",children:[(0,l.jsx)("h4",{className:"form-section-title",children:"Configuration"}),(0,l.jsxs)("div",{className:"form-grid form-grid-2",children:[(0,l.jsxs)("div",{className:"form-group",children:[(0,l.jsx)("label",{children:"Preset Template"}),(0,l.jsxs)("select",{value:f?ae.config_version:ie.config_version,onChange:e=>f?ne((0,r.A)((0,r.A)({},ae),{},{config_version:e.target.value})):oe((0,r.A)((0,r.A)({},ie),{},{config_version:e.target.value})),className:"full-width",children:[(0,l.jsx)("option",{value:"",children:"-- Manual Configuration --"}),K&&(0,l.jsx)("option",{value:"",disabled:!0,children:"Loading presets..."}),!K&&H.map(e=>(0,l.jsxs)("option",{value:me(e),children:[e.name," (",me(e)||"no ID",")"]},e.id))]}),(0,l.jsx)("small",{className:"form-hint",children:"Selecting a preset sets the Config Version ID below."})]}),(0,l.jsxs)("div",{className:"form-group",children:[(0,l.jsx)("label",{children:"Config Version ID"}),(0,l.jsx)("input",{type:"text",value:f?ae.config_version:ie.config_version,onChange:e=>f?ne((0,r.A)((0,r.A)({},ae),{},{config_version:e.target.value})):oe((0,r.A)((0,r.A)({},ie),{},{config_version:e.target.value})),autoComplete:"off",placeholder:"Manual Config ID"})]})]})]})]}),f&&(0,l.jsx)("div",{style:{padding:"0 24px"},children:(0,l.jsx)(c.A,{createdBy:f.created_by_username,createdAt:f.created_at,updatedBy:f.updated_by_username,updatedAt:f.updated_at})}),(0,l.jsxs)("div",{className:"form-actions",style:{padding:"24px"},children:[(0,l.jsx)("button",{type:"submit",className:"btn",children:f?"Save Changes":"Register Device"}),(0,l.jsx)("button",{type:"button",onClick:pe,className:"btn btn-secondary",children:"Cancel"})]})]})]})})]})}},5560(e,t,s){s.d(t,{K:()=>c});var r=s(2555);class a{constructor(){this.cache=new Map,this.subscribers=new Map}set(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:a.DEFAULT_TTL,r=arguments.length>3?arguments[3]:void 0;this.cache.set(e,{data:t,timestamp:Date.now(),expiresIn:s,staleTime:null!==r&&void 0!==r?r:Math.min(s/2,a.STALE_TIME)}),this.notifySubscribers(e,t)}get(e){const t=this.cache.get(e);if(!t)return null;return Date.now()-t.timestamp>t.expiresIn?(this.cache.delete(e),null):t.data}getWithStaleStatus(e){var t;const s=this.cache.get(e);if(!s)return null;const r=Date.now()-s.timestamp,a=r>s.expiresIn,n=r>(null!==(t=s.staleTime)&&void 0!==t?t:s.expiresIn/2);return a?(this.cache.delete(e),null):{data:s.data,isStale:n,isExpired:!1}}has(e){const t=this.cache.get(e);if(!t)return!1;return!(Date.now()-t.timestamp>t.expiresIn)||(this.cache.delete(e),!1)}isStale(e){var t;const s=this.cache.get(e);if(!s)return!0;return Date.now()-s.timestamp>(null!==(t=s.staleTime)&&void 0!==t?t:s.expiresIn/2)}clear(e){this.cache.delete(e)}clearPattern(e){const t="string"===typeof e?new RegExp(e):e,s=[];this.cache.forEach((e,r)=>{t.test(r)&&s.push(r)}),s.forEach(e=>this.cache.delete(e))}clearAll(){this.cache.clear()}size(){return this.cache.size}subscribe(e,t){this.subscribers.has(e)||this.subscribers.set(e,new Set);const s={callback:t};return this.subscribers.get(e).add(s),()=>{const t=this.subscribers.get(e);t&&(t.delete(s),0===t.size&&this.subscribers.delete(e))}}subscribePattern(e,t){const s="__pattern__".concat(e.source);this.subscribers.has(s)||this.subscribers.set(s,new Set);const r={callback:t,pattern:e};return this.subscribers.get(s).add(r),()=>{const e=this.subscribers.get(s);e&&(e.delete(r),0===e.size&&this.subscribers.delete(s))}}notifySubscribers(e,t){const s=this.subscribers.get(e);s&&s.forEach(s=>{try{s.callback(t)}catch(r){console.error("Cache subscriber error for key ".concat(e,":"),r)}}),this.subscribers.forEach((s,r)=>{r.startsWith("__pattern__")&&s.forEach(s=>{if(s.pattern&&s.pattern.test(e))try{s.callback(t)}catch(r){console.error("Cache pattern subscriber error for key ".concat(e,":"),r)}})})}keys(){return Array.from(this.cache.keys())}getStats(){return{size:this.cache.size,keys:this.keys(),subscribers:Array.from(this.subscribers.values()).reduce((e,t)=>e+t.size,0)}}static getTTL(){switch(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"short"){case"realtime":return a.REALTIME_TTL;case"long":return a.LONG_TTL;default:return a.DEFAULT_TTL}}}a.DEFAULT_TTL=3e5,a.LONG_TTL=18e5,a.REALTIME_TTL=1e4,a.STALE_TIME=3e4;const n=new a,i=3e5,o="https://smart-solar-django-backend.vercel.app/api";const c=new class{getAuthHeaders(){const e=localStorage.getItem("authTokens");if(e)try{const t=JSON.parse(e);return{Authorization:"Bearer ".concat(t.access),"Content-Type":"application/json"}}catch(t){console.error("Error parsing auth tokens:",t)}return{"Content-Type":"application/json"}}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const s="".concat(o).concat(e);let a=this.getAuthHeaders(),n=await fetch(s,(0,r.A)((0,r.A)({},t),{},{headers:(0,r.A)((0,r.A)({},a),t.headers)}));if(401===n.status){await this.refreshToken()&&(a=this.getAuthHeaders(),n=await fetch(s,(0,r.A)((0,r.A)({},t),{},{headers:(0,r.A)((0,r.A)({},a),t.headers)})))}if(401===n.status)throw localStorage.removeItem("authTokens"),localStorage.removeItem("authUser"),window.location.href="/login",new Error("Authentication required");if(!n.ok){const e=await n.text();throw new Error("API request failed: ".concat(n.status," ").concat(n.statusText," - ").concat(e))}return n.json()}async refreshToken(){const e=localStorage.getItem("authTokens");if(!e)return!1;try{const t=JSON.parse(e),s=await fetch("".concat(o,"/auth/token/refresh/"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh:t.refresh})});if(s.ok){const e={access:(await s.json()).access,refresh:t.refresh};return localStorage.setItem("authTokens",JSON.stringify(e)),!0}}catch(t){console.error("Token refresh failed:",t)}return!1}async getConfiguration(){return this.request("/config/")}async getTelemetry(){return this.request("/telemetry/")}async provisionDevice(e){const t=await fetch("".concat(o,"/devices/provision"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error("Provisioning failed: ".concat(t.statusText));return t.json()}async getAlerts(){const e="alerts",t=n.get(e);if(t)return t;const s=await this.request("/alerts/");return n.set(e,s,i),s}async getSystemHealth(){const e="system_health",t=n.get(e);if(t)return t;const s=await this.request("/health/");return n.set(e,s,i),s}async getKPIs(){const e="kpis",t=n.get(e);if(t)return t;const s=await this.request("/kpis/");return n.set(e,s,i),s}async getUsers(e){const t="users_".concat(e||"all"),s=n.get(t);if(s)return s;const r=e?"?search=".concat(encodeURIComponent(e)):"",a=await this.request("/users/".concat(r));return n.set(t,a,i),a}async createUser(e){const t=await this.request("/users/create/",{method:"POST",body:JSON.stringify(e)});return n.clear("users_all"),n.clearAll(),t}async createEmployee(e){const t=await this.request("/users/create/",{method:"POST",body:JSON.stringify((0,r.A)((0,r.A)({},e),{},{is_staff:!0}))});return n.clear("users_all"),t}async getUserDevices(e){return this.request("/users/".concat(e,"/devices/"))}async updateUser(e,t){const s=await this.request("/users/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)});return n.clear("users_all"),s}async deleteUser(e){const t=await this.request("/users/".concat(e,"/delete/"),{method:"DELETE"});return n.clear("users_all"),t}async getProfile(){return this.request("/profile/")}async updateProfile(e){return this.request("/profile/update/",{method:"PUT",body:JSON.stringify(e)})}async changePassword(e){return this.request("/profile/change-password/",{method:"POST",body:JSON.stringify(e)})}async getCustomers(e){const t=e?"?search=".concat(encodeURIComponent(e)):"";return this.request("/customers/".concat(t))}async createCustomer(e){return this.request("/customers/create/",{method:"POST",body:JSON.stringify(e)})}async getCustomer(e){return this.request("/customers/".concat(e,"/"))}async updateCustomer(e,t){return this.request("/customers/".concat(e,"/update/"),{method:"PUT",body:JSON.stringify(t)})}async deleteCustomer(e){return this.request("/customers/".concat(e,"/delete/"),{method:"DELETE"})}async getPresets(){const e="presets",t=n.get(e);if(t)return t;const s=await this.request("/presets/");return n.set(e,s,18e5),s}async createPreset(e){const t=await this.request("/presets/create/",{method:"POST",body:JSON.stringify(e)});return n.clear("presets"),t}async updatePreset(e,t){const s=await this.request("/presets/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)});return n.clear("presets"),s}async deletePreset(e){const t=await this.request("/presets/".concat(e,"/delete/"),{method:"DELETE"});return n.clear("presets"),t}async getGlobalSlaves(){return this.request("/slaves/")}async createGlobalSlave(e){return this.request("/slaves/create/",{method:"POST",body:JSON.stringify(e)})}async updateGlobalSlave(e,t){return this.request("/slaves/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)})}async deleteGlobalSlave(e){return this.request("/slaves/".concat(e,"/delete/"),{method:"DELETE"})}async getDevices(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:25;const r=new URLSearchParams;e&&r.append("search",e),r.append("page",t.toString()),r.append("page_size",s.toString());const a=r.toString();return this.request("/devices/?".concat(a))}async createDevice(e){return this.request("/devices/create/",{method:"POST",body:JSON.stringify(e)})}async updateDevice(e,t){return this.request("/devices/".concat(e,"/"),{method:"PUT",body:JSON.stringify(t)})}async deleteDevice(e){return this.request("/devices/".concat(e,"/delete/"),{method:"DELETE"})}async deleteDevicesBulk(e){return this.request("/devices/delete-bulk/",{method:"POST",body:JSON.stringify({device_ids:e})})}async getSlaves(e){return this.request("/presets/".concat(e,"/slaves/"))}async createSlave(e,t){return this.request("/presets/".concat(e,"/slaves/create/"),{method:"POST",body:JSON.stringify(t)})}async updateSlave(e,t,s){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/"),{method:"PUT",body:JSON.stringify(s)})}async deleteSlave(e,t){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/delete/"),{method:"DELETE"})}async addSlavesToPreset(e,t){return this.request("/presets/".concat(e,"/slaves/add/"),{method:"POST",body:JSON.stringify({slave_ids:t})})}async detachSlaveFromPreset(e,t){return this.request("/presets/".concat(e,"/slaves/").concat(t,"/detach/"),{method:"POST"})}async getFirmwareVersions(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=new URLSearchParams;return t.append("active",e.toString()),this.request("/ota/firmware/?".concat(t.toString()))}async uploadFirmwareVersion(e){const t="".concat(o,"/ota/firmware/create/"),s=localStorage.getItem("authTokens");if(!s)throw new Error("Authentication required");const r=JSON.parse(s);let a={Authorization:"Bearer ".concat(r.access)},n=await fetch(t,{method:"POST",headers:a,body:e});if(401===n.status){if(await this.refreshToken()){const s=JSON.parse(localStorage.getItem("authTokens")||"{}");a={Authorization:"Bearer ".concat(s.access)},n=await fetch(t,{method:"POST",headers:a,body:e})}}if(401===n.status)throw localStorage.removeItem("authTokens"),localStorage.removeItem("authUser"),window.location.href="/login",new Error("Authentication required");if(!n.ok){const e=await n.text();throw new Error("Upload failed: ".concat(n.status," ").concat(n.statusText," - ").concat(e))}return n.json()}async updateFirmwareVersion(e,t){return this.request("/ota/firmware/".concat(e,"/"),{method:"PATCH",body:JSON.stringify(t)})}async deleteFirmwareVersion(e){return this.request("/ota/firmware/".concat(e,"/delete/"),{method:"DELETE"})}async getDeviceUpdateLogs(e){return this.request("/ota/devices/".concat(e,"/logs"))}async getOTAConfig(){return this.request("/ota/config/")}async updateOTAConfig(e){return this.request("/ota/config/update/",{method:"PATCH",body:JSON.stringify(e)})}async getOTAHealth(){return this.request("/ota/health/")}}}}]);
//# sourceMappingURL=392.a458de6e.chunk.js.map