"use strict";(self.webpackChunksmart_solar_frontend=self.webpackChunksmart_solar_frontend||[]).push([[923],{7923(e,s,t){t.d(s,{OTA:()=>c});var a=t(2555),r=t(5043),n=t(5560),i=(t(4050),t(579));const c=()=>{const[e,s]=(0,r.useState)([]),[t,c]=(0,r.useState)(null),[o,l]=(0,r.useState)(null),[d,u]=(0,r.useState)(!1),[h,m]=(0,r.useState)(null),[p,g]=(0,r.useState)({version:"",description:"",release_notes:""}),[f,y]=(0,r.useState)(null),[v,x]=(0,r.useState)(""),[j,N]=(0,r.useState)("");(0,r.useEffect)(()=>{w()},[]);const w=async()=>{u(!0);try{const[e,t,a]=await Promise.all([n.K.getFirmwareVersions(!1),n.K.getOTAConfig(),n.K.getOTAHealth()]);s(e),c(t),y(t),l(a)}catch(e){N(e.message||"Failed to load OTA data")}finally{u(!1)}};return(0,i.jsxs)("div",{className:"admin-container",children:[(0,i.jsxs)("div",{className:"admin-header",children:[(0,i.jsx)("h1",{children:"Over-The-Air (OTA) Updates"}),(0,i.jsx)("div",{className:"health-status",children:o&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("span",{className:"status-badge status-badge-".concat("ok"===o.status?"success":"danger"),children:o.status.toUpperCase()}),(0,i.jsxs)("span",{className:"ml-2",children:[o.firmware_versions," versions (",o.active_firmware," active)"]})]})})]}),v&&(0,i.jsxs)("div",{className:"alert alert-success mt-3 fade-in",children:[v,(0,i.jsx)("button",{className:"alert-close",onClick:()=>x(""),children:"\xd7"})]}),j&&(0,i.jsxs)("div",{className:"alert alert-danger mt-3 fade-in",children:[j,(0,i.jsx)("button",{className:"alert-close",onClick:()=>N(""),children:"\xd7"})]}),d&&(0,i.jsx)("div",{className:"loading-spinner",children:"Loading OTA data..."}),(0,i.jsxs)("div",{className:"admin-grid",children:[(0,i.jsxs)("div",{className:"admin-card",children:[(0,i.jsx)("h2",{children:"Upload New Firmware"}),(0,i.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),h&&p.version)try{u(!0);const e=new FormData;e.append("file",h),e.append("version",p.version),e.append("filename",h.name),e.append("size",h.size.toString()),e.append("description",p.description||""),e.append("release_notes",p.release_notes||""),e.append("is_active","false"),await n.K.uploadFirmwareVersion(e),x("Firmware uploaded successfully"),m(null),g({version:"",description:"",release_notes:""}),w()}catch(s){N(s.message||"Failed to upload firmware")}finally{u(!1)}else N("Please select a file and enter version number")},className:"form",children:[(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Version (e.g., 0x00020000)"}),(0,i.jsx)("input",{type:"text",className:"form-control",placeholder:"0x00020000",value:p.version,onChange:e=>g((0,a.A)((0,a.A)({},p),{},{version:e.target.value}))})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Firmware File"}),(0,i.jsx)("input",{type:"file",className:"form-control",accept:".bin,.hex,.elf",onChange:e=>{var s;null!==(s=e.target.files)&&void 0!==s&&s[0]&&m(e.target.files[0])}}),h&&(0,i.jsxs)("small",{className:"form-text",children:["File: ",h.name]})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Description"}),(0,i.jsx)("textarea",{className:"form-control",placeholder:"Brief description of this firmware version",rows:2,value:p.description,onChange:e=>g((0,a.A)((0,a.A)({},p),{},{description:e.target.value}))})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Release Notes"}),(0,i.jsx)("textarea",{className:"form-control",placeholder:"Detailed release notes and changelog",rows:3,value:p.release_notes,onChange:e=>g((0,a.A)((0,a.A)({},p),{},{release_notes:e.target.value}))})]}),(0,i.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:d,children:d?"Uploading...":"Upload Firmware"})]})]}),(0,i.jsxs)("div",{className:"admin-card",children:[(0,i.jsx)("h2",{children:"Firmware Versions"}),0===e.length?(0,i.jsx)("p",{className:"text-muted",children:"No firmware versions uploaded yet"}):(0,i.jsx)("div",{className:"firmware-list",children:e.map(e=>(0,i.jsxs)("div",{className:"firmware-item ".concat(e.is_active?"active":""),children:[(0,i.jsxs)("div",{className:"firmware-header",children:[(0,i.jsx)("span",{className:"version-badge ".concat(e.is_active?"active":"inactive"),children:e.version}),(0,i.jsx)("span",{className:"filename",children:e.filename}),(0,i.jsxs)("span",{className:"size",children:["(",(e.size/1024/1024).toFixed(2)," MB)"]})]}),e.description&&(0,i.jsx)("p",{className:"description",children:e.description}),(0,i.jsxs)("div",{className:"firmware-footer",children:[(0,i.jsxs)("small",{className:"text-muted",children:["Created: ",new Date(e.created_at).toLocaleDateString()]}),(0,i.jsx)("button",{className:"btn btn-sm ".concat(e.is_active?"btn-danger":"btn-success"),onClick:()=>(async e=>{try{u(!0),await n.K.updateFirmwareVersion(e.id,{is_active:!e.is_active}),x("Firmware ".concat(e.is_active?"deactivated":"activated"," successfully")),w()}catch(s){N(s.message||"Failed to update firmware status")}finally{u(!1)}})(e),disabled:d,children:e.is_active?"Deactivate":"Activate"})]}),e.release_notes&&(0,i.jsxs)("details",{className:"mt-2",children:[(0,i.jsx)("summary",{children:"Release Notes"}),(0,i.jsx)("p",{className:"release-notes",children:e.release_notes})]})]},e.id))})]}),(0,i.jsxs)("div",{className:"admin-card",children:[(0,i.jsx)("h2",{children:"OTA Configuration"}),f&&(0,i.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),f)try{u(!0),await n.K.updateOTAConfig(f),x("OTA configuration updated successfully"),c(f)}catch(s){N(s.message||"Failed to update configuration")}finally{u(!1)}},className:"form",children:[(0,i.jsx)("div",{className:"form-group",children:(0,i.jsxs)("label",{className:"checkbox-label",children:[(0,i.jsx)("input",{type:"checkbox",checked:f.enable_auto_update,onChange:e=>y((0,a.A)((0,a.A)({},f),{},{enable_auto_update:e.target.checked}))}),(0,i.jsx)("span",{children:"Enable Automatic Updates"})]})}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Update Strategy"}),(0,i.jsxs)("select",{className:"form-control",value:f.update_strategy,onChange:e=>y((0,a.A)((0,a.A)({},f),{},{update_strategy:e.target.value})),children:[(0,i.jsx)("option",{value:"immediate",children:"Immediate - Push updates immediately"}),(0,i.jsx)("option",{value:"scheduled",children:"Scheduled - Push during maintenance window"}),(0,i.jsx)("option",{value:"manual",children:"Manual - Wait for device to request"})]})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Max Concurrent Updates"}),(0,i.jsx)("input",{type:"number",className:"form-control",min:"1",max:"50",value:f.max_concurrent_updates,onChange:e=>y((0,a.A)((0,a.A)({},f),{},{max_concurrent_updates:parseInt(e.target.value)}))}),(0,i.jsx)("small",{className:"form-text",children:"Maximum number of devices updating simultaneously"})]}),(0,i.jsxs)("div",{className:"form-group",children:[(0,i.jsx)("label",{children:"Firmware Retention (days)"}),(0,i.jsx)("input",{type:"number",className:"form-control",min:"1",max:"365",value:f.firmware_retention_days,onChange:e=>y((0,a.A)((0,a.A)({},f),{},{firmware_retention_days:parseInt(e.target.value)}))}),(0,i.jsx)("small",{className:"form-text",children:"Keep old firmware files for this many days before cleanup"})]}),(0,i.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:d,children:d?"Saving...":"Save Configuration"})]})]}),(0,i.jsxs)("div",{className:"admin-card",children:[(0,i.jsx)("h2",{children:"OTA Update Strategy"}),(0,i.jsxs)("div",{className:"info-box",children:[(0,i.jsxs)("h4",{children:["Current Strategy: ",null===t||void 0===t?void 0:t.update_strategy.toUpperCase()]}),(0,i.jsxs)("ul",{children:[(0,i.jsxs)("li",{children:[(0,i.jsx)("strong",{children:"Immediate:"})," Updates offered to devices immediately when activated"]}),(0,i.jsxs)("li",{children:[(0,i.jsx)("strong",{children:"Scheduled:"})," Updates offered during configured maintenance windows"]}),(0,i.jsxs)("li",{children:[(0,i.jsx)("strong",{children:"Manual:"})," Devices must explicitly request updates via API"]})]}),(0,i.jsx)("h4",{className:"mt-3",children:"For STM32 Devices:"}),(0,i.jsxs)("code",{className:"code-block",children:["POST /ota/devices/{device_id}/check",(0,i.jsx)("br",{}),'With: {"device_id": "...", "firmware_version": "0x00010000"}']}),(0,i.jsx)("h4",{className:"mt-3",children:"Device Response Format:"}),(0,i.jsx)("pre",{className:"code-block",children:JSON.stringify({id:"fw_1",version:"0x00020000",size:1048576,url:"https://api.../ota/firmware/1/download",checksum:"sha256_hash",status:1},null,2)})]})]})]})]})}},5560(e,s,t){t.d(s,{K:()=>o});var a=t(2555);class r{constructor(){this.cache=new Map}set(e,s){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:r.DEFAULT_TTL;this.cache.set(e,{data:s,timestamp:Date.now(),expiresIn:t})}get(e){const s=this.cache.get(e);if(!s)return null;return Date.now()-s.timestamp>s.expiresIn?(this.cache.delete(e),null):s.data}has(e){const s=this.cache.get(e);if(!s)return!1;return!(Date.now()-s.timestamp>s.expiresIn)||(this.cache.delete(e),!1)}clear(e){this.cache.delete(e)}clearAll(){this.cache.clear()}size(){return this.cache.size}static getTTL(){return"long"===(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"short")?r.LONG_TTL:r.DEFAULT_TTL}}r.DEFAULT_TTL=3e5,r.LONG_TTL=18e5;const n=new r,i=3e5,c="https://smart-solar-django-backend.vercel.app/api";const o=new class{getAuthHeaders(){const e=localStorage.getItem("authTokens");if(e)try{const s=JSON.parse(e);return{Authorization:"Bearer ".concat(s.access),"Content-Type":"application/json"}}catch(s){console.error("Error parsing auth tokens:",s)}return{"Content-Type":"application/json"}}async request(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const t="".concat(c).concat(e);let r=this.getAuthHeaders(),n=await fetch(t,(0,a.A)((0,a.A)({},s),{},{headers:(0,a.A)((0,a.A)({},r),s.headers)}));if(401===n.status){await this.refreshToken()&&(r=this.getAuthHeaders(),n=await fetch(t,(0,a.A)((0,a.A)({},s),{},{headers:(0,a.A)((0,a.A)({},r),s.headers)})))}if(401===n.status)throw localStorage.removeItem("authTokens"),localStorage.removeItem("authUser"),window.location.href="/login",new Error("Authentication required");if(!n.ok){const e=await n.text();throw new Error("API request failed: ".concat(n.status," ").concat(n.statusText," - ").concat(e))}return n.json()}async refreshToken(){const e=localStorage.getItem("authTokens");if(!e)return!1;try{const s=JSON.parse(e),t=await fetch("".concat(c,"/auth/token/refresh/"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh:s.refresh})});if(t.ok){const e={access:(await t.json()).access,refresh:s.refresh};return localStorage.setItem("authTokens",JSON.stringify(e)),!0}}catch(s){console.error("Token refresh failed:",s)}return!1}async getConfiguration(){return this.request("/config/")}async getTelemetry(){return this.request("/telemetry/")}async provisionDevice(e){const s=await fetch("".concat(c,"/devices/provision"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok)throw new Error("Provisioning failed: ".concat(s.statusText));return s.json()}async getAlerts(){const e="alerts",s=n.get(e);if(s)return s;const t=await this.request("/alerts/");return n.set(e,t,i),t}async getSystemHealth(){const e="system_health",s=n.get(e);if(s)return s;const t=await this.request("/health/");return n.set(e,t,i),t}async getKPIs(){const e="kpis",s=n.get(e);if(s)return s;const t=await this.request("/kpis/");return n.set(e,t,i),t}async getUsers(e){const s="users_".concat(e||"all"),t=n.get(s);if(t)return t;const a=e?"?search=".concat(encodeURIComponent(e)):"",r=await this.request("/users/".concat(a));return n.set(s,r,i),r}async createUser(e){const s=await this.request("/users/create/",{method:"POST",body:JSON.stringify(e)});return n.clear("users_all"),n.clearAll(),s}async createEmployee(e){const s=await this.request("/users/create/",{method:"POST",body:JSON.stringify((0,a.A)((0,a.A)({},e),{},{is_staff:!0}))});return n.clear("users_all"),s}async getUserDevices(e){return this.request("/users/".concat(e,"/devices/"))}async updateUser(e,s){const t=await this.request("/users/".concat(e,"/"),{method:"PUT",body:JSON.stringify(s)});return n.clear("users_all"),t}async deleteUser(e){const s=await this.request("/users/".concat(e,"/delete/"),{method:"DELETE"});return n.clear("users_all"),s}async getProfile(){return this.request("/profile/")}async updateProfile(e){return this.request("/profile/update/",{method:"PUT",body:JSON.stringify(e)})}async changePassword(e){return this.request("/profile/change-password/",{method:"POST",body:JSON.stringify(e)})}async getCustomers(e){const s=e?"?search=".concat(encodeURIComponent(e)):"";return this.request("/customers/".concat(s))}async createCustomer(e){return this.request("/customers/create/",{method:"POST",body:JSON.stringify(e)})}async getCustomer(e){return this.request("/customers/".concat(e,"/"))}async updateCustomer(e,s){return this.request("/customers/".concat(e,"/update/"),{method:"PUT",body:JSON.stringify(s)})}async deleteCustomer(e){return this.request("/customers/".concat(e,"/delete/"),{method:"DELETE"})}async getPresets(){const e="presets",s=n.get(e);if(s)return s;const t=await this.request("/presets/");return n.set(e,t,18e5),t}async createPreset(e){const s=await this.request("/presets/create/",{method:"POST",body:JSON.stringify(e)});return n.clear("presets"),s}async updatePreset(e,s){const t=await this.request("/presets/".concat(e,"/"),{method:"PUT",body:JSON.stringify(s)});return n.clear("presets"),t}async deletePreset(e){const s=await this.request("/presets/".concat(e,"/delete/"),{method:"DELETE"});return n.clear("presets"),s}async getGlobalSlaves(){return this.request("/slaves/")}async createGlobalSlave(e){return this.request("/slaves/create/",{method:"POST",body:JSON.stringify(e)})}async updateGlobalSlave(e,s){return this.request("/slaves/".concat(e,"/"),{method:"PUT",body:JSON.stringify(s)})}async deleteGlobalSlave(e){return this.request("/slaves/".concat(e,"/delete/"),{method:"DELETE"})}async getDevices(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:25;const a=new URLSearchParams;e&&a.append("search",e),a.append("page",s.toString()),a.append("page_size",t.toString());const r=a.toString();return this.request("/devices/?".concat(r))}async createDevice(e){return this.request("/devices/create/",{method:"POST",body:JSON.stringify(e)})}async updateDevice(e,s){return this.request("/devices/".concat(e,"/"),{method:"PUT",body:JSON.stringify(s)})}async deleteDevice(e){return this.request("/devices/".concat(e,"/delete/"),{method:"DELETE"})}async deleteDevicesBulk(e){return this.request("/devices/delete-bulk/",{method:"POST",body:JSON.stringify({device_ids:e})})}async getSlaves(e){return this.request("/presets/".concat(e,"/slaves/"))}async createSlave(e,s){return this.request("/presets/".concat(e,"/slaves/create/"),{method:"POST",body:JSON.stringify(s)})}async updateSlave(e,s,t){return this.request("/presets/".concat(e,"/slaves/").concat(s,"/"),{method:"PUT",body:JSON.stringify(t)})}async deleteSlave(e,s){return this.request("/presets/".concat(e,"/slaves/").concat(s,"/delete/"),{method:"DELETE"})}async addSlavesToPreset(e,s){return this.request("/presets/".concat(e,"/slaves/add/"),{method:"POST",body:JSON.stringify({slave_ids:s})})}async getFirmwareVersions(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const s=new URLSearchParams;return s.append("active",e.toString()),this.request("/ota/firmware/?".concat(s.toString()))}async uploadFirmwareVersion(e){const s=this.getAuthHeaders();return delete s["Content-Type"],fetch("".concat(c,"/ota/firmware/create/"),{method:"POST",headers:(0,a.A)((0,a.A)({},s),{},{Authorization:"Bearer ".concat(JSON.parse(localStorage.getItem("authTokens")||"{}").access)}),body:e}).then(e=>e.json())}async updateFirmwareVersion(e,s){return this.request("/ota/firmware/".concat(e,"/"),{method:"PATCH",body:JSON.stringify(s)})}async getDeviceUpdateLogs(e){return this.request("/ota/devices/".concat(e,"/logs"))}async getOTAConfig(){return this.request("/ota/config/")}async updateOTAConfig(e){return this.request("/ota/config/update/",{method:"PATCH",body:JSON.stringify(e)})}async getOTAHealth(){return this.request("/ota/health/")}}}}]);
//# sourceMappingURL=923.c62814d3.chunk.js.map